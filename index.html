<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–†–µ–¥–∞–∫—Ç–æ—Ä –∫–∞—Ä—Ç—ã –ó–ö–û</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    #panel { position: absolute; top: 10px; left: 10px; z-index: 1000; background: rgba(255,255,255,0.98); padding: 14px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.25); width: 270px; font-family: system-ui, sans-serif; transition: all 0.3s ease; max-height: 85vh; overflow-y: auto; }
    #panel.hidden { opacity: 0; transform: translateX(-320px); pointer-events: none; }
    #toggleArrow { position: absolute; top: 50%; left: 280px; transform: translateY(-50%); background: #007bff; color: white; border: none; border-radius: 0 6px 6px 0; width: 26px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1100; box-shadow: 1px 2px 5px rgba(0,0,0,0.3); font-size: 18px; transition: left 0.3s ease, opacity 0.3s ease; }
    #toggleArrow.hidden { opacity: 0; pointer-events: none; }
    #panel input, #panel textarea, #panel select { width: 100%; margin-bottom: 6px; padding: 6px 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; }
    #panel button { width: 100%; background: #007bff; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; transition: background 0.2s; font-size: 14px; margin-bottom: 5px; }
    #panel button:hover { background: #0056b3; }
    #panel .delete-btn, #panel .route-del { width: auto !important; padding: 4px 8px; }
    .point-item { display: flex; align-items: center; gap: 4px; padding: 6px; border-radius: 6px; margin-bottom: 4px; background: #f2f2f2; cursor: pointer; font-size: 14px; min-width: 0; }
    .point-item.active { outline: 2px solid #007bff; }
    body.dark .point-item.active { outline: 2px solid #4da3ff; }
    .point-text { flex: 1; min-width: 0; overflow: hidden; }
    .point-text b, .point-text small { display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .delete-btn { background: #dc3545; color: white; border: none; border-radius: 5px; padding: 4px 8px; font-size: 13px; cursor: pointer; flex-shrink: 0; }
    .leaflet-control-zoom { right: 15px !important; bottom: 80px !important; }
    #mobileArrows { position: absolute; bottom: 20px; right: 20px; display: flex; gap: 10px; z-index: 1200; }
    .nav-btn { background: rgba(0,123,255,0.9); border: none; color: white; width: 46px; height: 46px; border-radius: 50%; font-size: 20px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; }
    .nav-btn:active { background: #0056b3; transform: scale(0.96); }
    #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 2000; font-family: system-ui, sans-serif; }

    #panel { transition: all 0.3s ease, background 0.4s ease, color 0.4s ease; color: #111; }
    #panel input, #panel textarea, #panel select { transition: background 0.4s ease, color 0.4s ease, border-color 0.4s ease; }
    .point-item { transition: background 0.4s ease, color 0.4s ease; }
    body.dark #panel { background: rgba(22,22,30,0.97); color: #e0e0e0; box-shadow: 0 2px 12px rgba(0,0,0,0.6); }
    body.dark #panel input, body.dark #panel textarea, body.dark #panel select { background: #2a2a38; color: #e0e0e0; border-color: #444; }
    body.dark #panel label { color: #bbb; }
    body.dark #panel h3 { color: #fff; }
    body.dark .point-item { background: #2a2a38; color: #e0e0e0; }
    body.dark .point-item:hover { background: #33334a; }
    body.dark #toggleArrow { background: #1e90ff; }

    body.dark #panel::-webkit-scrollbar { width: 6px; }
    body.dark #panel::-webkit-scrollbar-track { background: #16161e; border-radius: 10px; }
    body.dark #panel::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
    body.dark #panel::-webkit-scrollbar-thumb:hover { background: #666; }

    .point-item { cursor: grab; }
    .point-item.dragging { opacity: 0.4; cursor: grabbing; }
    .point-item.drag-over { outline: 2px dashed #007bff; background: #d0e8ff; }
    body.dark .point-item.drag-over { background: #1a2a40; outline-color: #4da3ff; }
    .drag-handle { color: #aaa; font-size: 16px; margin-right: 5px; cursor: grab; user-select: none; flex-shrink: 0; }
    body.dark .drag-handle { color: #555; }
    #routePanel { display:none; }
    #routePanel.active { display:block; }
    #mainPanel.route-hidden { display:none; }
    #routeBtn { background: #6f42c1; }
    #routeBtn.active { background: #4a148c; }
    .route-item { display:flex; align-items:center; gap:4px; padding:5px 6px; border-radius:6px; margin-bottom:4px; background:#f2f2f2; font-size:13px; cursor:grab; }
    .route-item.dragging { opacity:0.4; }
    .route-item.drag-over { outline:2px dashed #6f42c1; }
    .route-num { background:#6f42c1; color:#fff; border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:bold; flex-shrink:0; }
    .route-del { background:none; border:none; color:#dc3545; font-size:15px; cursor:pointer; padding:0 2px; flex-shrink:0; margin-left:auto; }
    .route-add-btn { background:#6f42c1; }
    body.dark .route-item { background:#2a2a38; color:#e0e0e0; }
    body.dark .route-item.drag-over { background:#2a1a40; }

    #onlineBadge { display:flex; align-items:center; gap:5px; font-size:12px; color:#555; margin-bottom:8px; }
    #onlineDot { width:8px; height:8px; border-radius:50%; background:#28a745; animation:blink 2s infinite; flex-shrink:0; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.35} }
    body.dark #onlineBadge { color:#aaa; }

    .wiki-btn { background:#f8a100 !important; color:#fff; border:none; border-radius:4px; padding:3px 7px; font-size:12px; cursor:pointer; flex-shrink:0; width:auto !important; }
    .wiki-btn:disabled { opacity:.5; cursor:default; }

    .route-q-btn { background:#6f42c1 !important; color:#fff; border:none; border-radius:5px; padding:4px 7px; font-size:12px; cursor:pointer; flex-shrink:0; width:auto !important; }

    #adminPanel { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; width:90%; max-width:800px; max-height:80vh; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.3); z-index:3000; overflow:hidden; }
    #adminPanel.active { display:flex; flex-direction:column; }
    #adminHeader { display:flex; justify-content:space-between; align-items:center; padding:15px 20px; background:#007bff; color:white; }
    #adminClose { background:none; border:none; color:white; font-size:24px; cursor:pointer; padding:0; width:30px; }
    #adminContent { flex:1; overflow-y:auto; padding:20px; }
    .visitor-item { padding:12px; border-bottom:1px solid #eee; font-size:14px; }
    .visitor-item:hover { background:#f5f5f5; }
    .visitor-ip { font-weight:bold; color:#007bff; }
    .visitor-meta { color:#666; font-size:12px; margin-top:4px; }
    #adminBadge { position:fixed; bottom:80px; left:20px; background:#dc3545; color:white; padding:8px 12px; border-radius:20px; font-size:12px; cursor:pointer; z-index:1500; box-shadow:0 2px 6px rgba(0,0,0,0.3); }
    body.dark #adminPanel { background:#1a1a24; color:#e0e0e0; }
    body.dark #adminHeader { background:#1e90ff; }
    body.dark .visitor-item { border-bottom-color:#333; }
    body.dark .visitor-item:hover { background:#2a2a38; }
    body.dark .visitor-meta { color:#aaa; }
  </style>
</head>
<body>
  <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ—á–µ–∫...</div>
  <div id="panel">
    <div id="onlineBadge"><span id="onlineDot"></span><span id="onlineCount">...</span> –æ–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å</div>
    <h3 id="formTitle">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É</h3>
    <label>–¢–∏–ø –∫–∞—Ä—Ç—ã:</label>
    <select id="mapType"><option value="osm">–û–±—ã—á–Ω–∞—è</option><option value="satellite">–°–ø—É—Ç–Ω–∏–∫–æ–≤–∞—è</option></select>
    <input type="text" id="pointLat" placeholder="–®–∏—Ä–æ—Ç–∞ (lat)" />
    <input type="text" id="pointLng" placeholder="–î–æ–ª–≥–æ—Ç–∞ (lng)" />
    <input type="text" id="pointName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
    <textarea id="pointDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="2" style="resize:vertical;"></textarea>
    <button id="selectModeBtn">–í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</button>
    <button id="addPoint">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É</button>
    <button id="migrateFromLocal" style="background:#28a745;">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∏–∑ localStorage</button>
    <button id="bulkWiki" style="background:#f8a100;">üìñ –î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è –≤—Å–µ–º (–í–∏–∫–∏–ø–µ–¥–∏—è)</button>
    <button id="deleteAll" style="background:#dc3545;">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç–æ—á–∫–∏</button>
    <button id="saveJSON" style="background:#17a2b8;">–≠–∫—Å–ø–æ—Ä—Ç –≤ JSON</button>
    <label style="font-size:13px;color:#333;">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ JSON:</label>
    <input type="file" id="importJSON" accept=".json" />
    <label style="font-size:13px;color:#333;">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ KML/KMZ:</label>
    <input type="file" id="importKml" accept=".kml,.kmz" />
    <input type="text" id="searchPoints" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º..." style="margin-top:10px;padding:6px;border-radius:6px;border:1px solid #ccc;font-size:14px;"/>
    <button id="routeBtn" style="background:#6f42c1;margin-top:6px;">üó∫ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç ‚Üê‚Üí</button>
    <div id="mainPanel">
      <div id="pointsList"></div>
    </div>
    <div id="routePanel">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
        <b style="font-size:13px;">–ü–æ—Ä—è–¥–æ–∫ –º–∞—Ä—à—Ä—É—Ç–∞</b>
        <button id="routeClearBtn" style="background:#dc3545;width:auto;padding:3px 8px;font-size:12px;">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
      <p style="font-size:12px;color:#888;margin:0 0 6px;">–ü–µ—Ä–µ—Ç–∞—â–∏ —Ç–æ—á–∫–∏ —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫. –°—Ç—Ä–µ–ª–∫–∏ ‚Üê ‚Üí –±—É–¥—É—Ç —Å–ª–µ–¥–æ–≤–∞—Ç—å —ç—Ç–æ–º—É –º–∞—Ä—à—Ä—É—Ç—É.</p>
      <div id="routeList"></div>
      <div id="routeAddArea">
        <p style="font-size:12px;color:#888;margin:4px 0 4px;">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É –≤ –º–∞—Ä—à—Ä—É—Ç:</p>
        <input type="text" id="routeSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." style="margin-bottom:4px;"/>
        <div id="routeAddList"></div>
      </div>
    </div>
  </div>
  <button id="toggleArrow">&lt;</button>
  <div id="map"></div>
  <div id="mobileArrows">
    <button class="nav-btn" id="prevBtn">‚Üê</button>
    <button class="nav-btn" id="nextBtn">‚Üí</button>
  </div>

  <div id="adminBadge">üîê –ê–¥–º–∏–Ω</div>

  <div id="adminPanel">
    <div id="adminHeader">
      <h3 style="margin:0;">–ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ —Å–∞–π—Ç–∞</h3>
      <button id="adminClose">√ó</button>
    </div>
    <div id="adminContent">
      <p style="color:#666;font-size:13px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const { createClient } = supabase;
    const supabaseUrl = 'https://diniabtxchgtbcfldwib.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpbmlhYnR4Y2hndGJjZmxkd2liIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MTI1NTIsImV4cCI6MjA4NjQ4ODU1Mn0.fWuFphXouWK35E_qNe6AbokMT-pXeSHodoga1UwYP6c';
    const sb = createClient(supabaseUrl, supabaseKey);

    let sessionId = null;
    
    async function trackVisitor() {
      try {
        const ua = navigator.userAgent;
        let device = 'Desktop';
        let browser = 'Unknown';
        let os = 'Unknown';

        if (/mobile/i.test(ua)) device = 'Mobile';
        else if (/tablet|ipad/i.test(ua)) device = 'Tablet';

        if (ua.indexOf('Firefox') > -1) browser = 'Firefox';
        else if (ua.indexOf('SamsungBrowser') > -1) browser = 'Samsung Browser';
        else if (ua.indexOf('Opera') > -1 || ua.indexOf('OPR') > -1) browser = 'Opera';
        else if (ua.indexOf('Trident') > -1) browser = 'IE';
        else if (ua.indexOf('Edge') > -1) browser = 'Edge';
        else if (ua.indexOf('Chrome') > -1) browser = 'Chrome';
        else if (ua.indexOf('Safari') > -1) browser = 'Safari';

        if (ua.indexOf('Windows') > -1) os = 'Windows';
        else if (ua.indexOf('Mac') > -1) os = 'MacOS';
        else if (ua.indexOf('Linux') > -1) os = 'Linux';
        else if (ua.indexOf('Android') > -1) os = 'Android';
        else if (ua.indexOf('iOS') > -1 || ua.indexOf('iPhone') > -1 || ua.indexOf('iPad') > -1) os = 'iOS';

        // Get IP
        let ip = 'Unknown';
        try {
          const ipRes = await fetch('https://api.ipify.org?format=json');
          const ipData = await ipRes.json();
          ip = ipData.ip;
        } catch {}

        const { data, error } = await sb.from('visitor_logs').insert([{
          ip,
          user_agent: ua,
          device,
          browser,
          os,
          last_seen: new Date().toISOString()
        }]).select();
        
        if (data && data[0]) {
          sessionId = data[0].id;
          setInterval(updateHeartbeat, 30000);
        }
      } catch (err) {
        console.error('Tracking error:', err);
      }
    }

    async function updateHeartbeat() {
      if (!sessionId) return;
      try {
        await sb.from('visitor_logs').update({ 
          last_seen: new Date().toISOString() 
        }).eq('id', sessionId);
      } catch (err) {
        console.error('Heartbeat error:', err);
      }
    }

    document.getElementById('adminBadge').onclick = async () => {
      const panel = document.getElementById('adminPanel');
      panel.classList.add('active');
      await loadAdminData();
    };

    async function loadAdminData() {
      try {
        const { data, error } = await sb.from('visitor_logs').select('*').order('visited_at', { ascending: false }).limit(200);
        if (error) throw error;

        const content = document.getElementById('adminContent');
        if (data.length === 0) {
          content.innerHTML = '<p style="color:#999;">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π</p>';
          return;
        }

        const now = new Date();
        const activeSessions = data.filter(v => {
          if (!v.last_seen) return false;
          const lastSeen = new Date(v.last_seen);
          const diff = (now - lastSeen) / 1000; // seconds
          return diff < 120; // 2 minutes
        });

        let html = `
          <div style="display:flex;gap:20px;margin-bottom:15px;flex-wrap:wrap;">
            <div style="background:#28a745;color:white;padding:10px 15px;border-radius:8px;">
              <div style="font-size:24px;font-weight:bold;">${activeSessions.length}</div>
              <div style="font-size:12px;">üü¢ –û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å</div>
            </div>
            <div style="background:#007bff;color:white;padding:10px 15px;border-radius:8px;">
              <div style="font-size:24px;font-weight:bold;">${data.length}</div>
              <div style="font-size:12px;">üìä –í—Å–µ–≥–æ –≤–∏–∑–∏—Ç–æ–≤</div>
            </div>
          </div>
        `;

        if (activeSessions.length > 0) {
          html += '<h4 style="margin:15px 0 10px;color:#28a745;">üü¢ –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ–π—á–∞—Å:</h4>';
          activeSessions.forEach(v => {
            const lastSeen = new Date(v.last_seen);
            const secondsAgo = Math.floor((now - lastSeen) / 1000);
            const timeAgo = secondsAgo < 60 ? `${secondsAgo} —Å–µ–∫ –Ω–∞–∑–∞–¥` : `${Math.floor(secondsAgo / 60)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            
            html += `
              <div class="visitor-item" style="border-left:3px solid #28a745;">
                <div class="visitor-ip">üü¢ ${v.ip}</div>
                <div class="visitor-meta">
                  üì± ${v.device} | üåç ${v.browser} | üíª ${v.os}<br>
                  ‚è± ${timeAgo}
                </div>
              </div>
            `;
          });
        }

        html += '<h4 style="margin:15px 0 10px;">üìú –ò—Å—Ç–æ—Ä–∏—è –≤–∏–∑–∏—Ç–æ–≤:</h4>';
        data.forEach(v => {
          const date = new Date(v.visited_at).toLocaleString('ru-RU');
          const isActive = activeSessions.includes(v);
          
          html += `
            <div class="visitor-item" style="${isActive ? 'opacity:0.5;' : ''}">
              <div class="visitor-ip">üåê ${v.ip}</div>
              <div class="visitor-meta">
                üì± ${v.device} | üåç ${v.browser} | üíª ${v.os}<br>
                üïê ${date}
              </div>
            </div>
          `;
        });
        content.innerHTML = html;
      } catch (err) {
        document.getElementById('adminContent').innerHTML = `<p style="color:red;">–û—à–∏–±–∫–∞: ${err.message}</p>`;
      }
    }

    document.getElementById('adminClose').onclick = () => {
      document.getElementById('adminPanel').classList.remove('active');
    };

    setInterval(() => {
      if (document.getElementById('adminPanel').classList.contains('active')) {
        loadAdminData();
      }
    }, 10000);

    trackVisitor();


    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    const satelliteLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}');
    const map = L.map('map', { zoomControl: false, attributionControl: false, layers: [osmLayer] }).setView([50.9, 52.0], 7);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    const panel = document.getElementById('panel');
    const arrow = document.getElementById('toggleArrow');

    function togglePanel() {
      const hidden = panel.classList.toggle('hidden');
      arrow.textContent = hidden ? '>' : '<';
      arrow.style.left = hidden ? '0px' : '280px';
      arrow.style.opacity = hidden ? '0' : '1';
    }

    arrow.addEventListener('click', togglePanel);
    arrow.addEventListener('touchstart', e => { e.preventDefault(); togglePanel(); });

    document.addEventListener('mousemove', e => {
      if (e.clientX < 10 && panel.classList.contains('hidden')) {
        arrow.style.opacity = '1';
      } else if (panel.classList.contains('hidden')) {
        arrow.style.opacity = '0';
      }
    });

    document.getElementById("mapType").addEventListener("change", e => {
      map.removeLayer(osmLayer);
      map.removeLayer(satelliteLayer);
      if (e.target.value === "satellite") {
        satelliteLayer.addTo(map);
        document.body.classList.add('dark');
      } else {
        osmLayer.addTo(map);
        document.body.classList.remove('dark');
      }
    });

    let points = [];
    let selectMode = false, currentIndex = -1, editIndex = -1;
    const listDiv = document.getElementById('pointsList');
    const searchInput = document.getElementById('searchPoints');
    const addBtn = document.getElementById('addPoint');
    const formTitle = document.getElementById('formTitle');

    function normalizePoint(p) {
      return { id: p.id, lat: Number(p.lat), lng: Number(p.lng), name: p.name || '', desc: p.desc || '' };
    }

    function addMarker(p, i) {
      const marker = L.marker([p.lat, p.lng]).addTo(map);
      const title = p.name ? `<b>${p.name}</b>` : `<b>–¢–æ—á–∫–∞ ${i + 1}</b>`;
      const descLine = p.desc ? `<br><i>${p.desc}</i>` : '';
      const popup = `${title}${descLine}`;
      marker.bindPopup(popup);
      marker.on("click", () => { flyToPoint(i); loadPointToForm(i); });
      p.marker = marker;
    }

    function loadPointToForm(i) {
      const p = points[i];
      document.getElementById('pointLat').value = p.lat;
      document.getElementById('pointLng').value = p.lng;
      document.getElementById('pointName').value = p.name || '';
      document.getElementById('pointDesc').value = p.desc || '';
      editIndex = i;
      addBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è";
      formTitle.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ—á–∫—É";
    }

    function clearForm() {
      document.getElementById('pointLat').value = "";
      document.getElementById('pointLng').value = "";
      document.getElementById('pointName').value = "";
      document.getElementById('pointDesc').value = "";
      editIndex = -1;
      addBtn.textContent = "–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É";
      formTitle.textContent = "–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É";
    }

    async function loadPoints() {
      try {
        const { data, error } = await sb.from('markers').select('*');
        if (error) throw error;
        
        points.forEach(p => p.marker && map.removeLayer(p.marker));
        points = [];
        
        data.forEach((p, i) => {
          const normalized = normalizePoint(p);
          points.push(normalized);
          addMarker(normalized, i);
        });
        
        if (points.length > 0) currentIndex = 0;
        refreshList();
        document.getElementById('loading').style.display = 'none';
      } catch (err) {
        console.error('Error loading points:', err);
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ—á–µ–∫ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö');
        document.getElementById('loading').style.display = 'none';
      }
    }

    let dragSrcIndex = null;

    function refreshList(filter = '') {
      listDiv.innerHTML = '';
      const lowerFilter = filter.toLowerCase();

      const filteredPoints = points
        .map((p, i) => ({ ...p, index: i }))
        .filter(p => {
          const coords = `${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}`;
          const name = (p.name || '').toLowerCase();
          return coords.includes(lowerFilter) || name.includes(lowerFilter);
        });

      points.forEach(p => {
        const visible = filteredPoints.some(fp => fp.lat === p.lat && fp.lng === p.lng);
        if (p.marker) p.marker.setOpacity(visible ? 1 : 0);
      });

      filteredPoints.forEach(p => {
        const div = document.createElement('div');
        div.className = 'point-item' + (p.index === currentIndex ? ' active' : '');
        div.draggable = true;
        div.dataset.index = p.index;

        const label = p.name ? `<b>${p.name}</b>` : `<b>–¢–æ—á–∫–∞ ${p.index + 1}</b>`;
        div.innerHTML = `<span class="drag-handle" title="–ü–µ—Ä–µ—Ç–∞—â–∏ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏">‚†ø</span><div class="point-text">${label}<br><small>${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}</small></div>`;
        div.onclick = () => { flyToPoint(p.index); loadPointToForm(p.index); };

        div.addEventListener('dragstart', e => {
          dragSrcIndex = p.index;
          setTimeout(() => div.classList.add('dragging'), 0);
          e.dataTransfer.effectAllowed = 'move';
        });
        div.addEventListener('dragend', () => div.classList.remove('dragging'));
        div.addEventListener('dragover', e => { e.preventDefault(); div.classList.add('drag-over'); });
        div.addEventListener('dragleave', () => div.classList.remove('drag-over'));
        div.addEventListener('drop', e => {
          e.preventDefault();
          div.classList.remove('drag-over');
          if (dragSrcIndex === null || dragSrcIndex === p.index) return;
          const moved = points.splice(dragSrcIndex, 1)[0];
          points.splice(p.index, 0, moved);
          dragSrcIndex = null;
          refreshList(searchInput.value.trim());
        });

        const del = document.createElement('button');
        del.textContent = 'üóë';
        del.className = 'delete-btn';
        del.onclick = async e => {
          e.stopPropagation();
          const pwd = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:');
          if (pwd !== '59872461') return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
          try {
            const { error } = await sb.from('markers').delete().eq('id', p.id);
            if (error) throw error;
            map.removeLayer(p.marker);
            points.splice(p.index, 1);
            refreshList(searchInput.value.trim());
          } catch (err) {
            console.error('Error deleting point:', err);
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ—á–∫–∏');
          }
        };

        const rqBtn = document.createElement('button');
        rqBtn.textContent = 'üó∫';
        rqBtn.className = 'route-q-btn';
        rqBtn.title = '–î–æ–±–∞–≤–∏—Ç—å –≤ –º–∞—Ä—à—Ä—É—Ç';
        rqBtn.onclick = e => {
          e.stopPropagation();
          if (!routeOrder.includes(p.index)) routeOrder.push(p.index);
          if (routeMode) renderRoutePanel();
        };

        const wikiBtn = document.createElement('button');
        wikiBtn.textContent = 'üìñ';
        wikiBtn.className = 'wiki-btn';
        wikiBtn.title = '–û–ø–∏—Å–∞–Ω–∏–µ –∏–∑ –í–∏–∫–∏–ø–µ–¥–∏–∏';
        wikiBtn.onclick = async e => {
          e.stopPropagation();
          if (!p.name) return alert('–£ —Ç–æ—á–∫–∏ –Ω–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –í–∏–∫–∏');
          wikiBtn.disabled = true; wikiBtn.textContent = 'üîç';
          try {
            const searches = [
              p.name + ' —Å–µ–ª–æ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω',
              p.name + ' –≥–æ—Ä–æ–¥ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω',
              p.name + ' –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω',
              p.name,
            ];

            let fullText = '';
            let foundTitle = '';

            for (const query of searches) {
              const searchRes = await fetch(
                `https://ru.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*&srlimit=5`
              );
              const searchJson = await searchRes.json();
              const results = searchJson?.query?.search || [];

              for (const r of results) {
                const titleLower = r.title.toLowerCase();
                const snippetLower = (r.snippet || '').toLowerCase();
                const isPerson =
                  snippetLower.includes('—Ä–æ–¥–∏–ª—Å—è') ||
                  snippetLower.includes('—Å–æ–≤–µ—Ç—Å–∫–∏–π') && snippetLower.includes('–∞–∫—Ç—ë—Ä') ||
                  snippetLower.includes('–±–∏–æ–≥—Ä–∞—Ñ–∏—è') ||
                  snippetLower.includes('–∫–∞–∑–∞—Ö—Å–∫–∏–π –ø–æ–ª–∏—Ç–∏–∫') ||
                  snippetLower.includes('–¥–µ–ø—É—Ç–∞—Ç') ||
                  /(–∞–∫—Ç—ë—Ä|–ø–µ–≤–µ—Ü|–ø–æ–ª–∏—Ç–∏–∫|—Å–ø–æ—Ä—Ç—Å–º–µ–Ω|—É—á—ë–Ω—ã–π|–ø–∏—Å–∞—Ç–µ–ª—å)/.test(snippetLower);
                if (isPerson) continue;

                const pageRes = await fetch(
                  `https://ru.wikipedia.org/w/api.php?action=query&prop=extracts&exsectionformat=plain&explaintext=true&titles=${encodeURIComponent(r.title)}&format=json&origin=*`
                );
                if (!pageRes.ok) continue;
                const pageJson = await pageRes.json();
                const pages = pageJson?.query?.pages || {};
                const page = Object.values(pages)[0];
                const text = (page?.extract || '').trim();

                const textLower = text.toLowerCase();
                const isPlaceLike =
                  textLower.includes('–Ω–∞—Å–µ–ª—ë–Ω–Ω—ã–π –ø—É–Ω–∫—Ç') ||
                  textLower.includes('—Å–µ–ª–æ') ||
                  textLower.includes('–≥–æ—Ä–æ–¥') ||
                  textLower.includes('–∞—É–ª') ||
                  textLower.includes('—Ä–∞–π–æ–Ω') ||
                  textLower.includes('–æ–±–ª–∞—Å—Ç—å') ||
                  textLower.includes('—Ä–µ–∫–∞') ||
                  textLower.includes('–æ–∑–µ—Ä–æ') ||
                  textLower.includes('—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω') ||
                  textLower.includes('–Ω–∞—Ö–æ–¥–∏—Ç—Å—è') ||
                  textLower.includes('–Ω–∞—Å–µ–ª–µ–Ω–∏–µ');
                const isPersonText =
                  textLower.includes('—Ä–æ–¥–∏–ª—Å—è') ||
                  textLower.includes('—Ä–æ–¥–∏–ª–∞—Å—å') ||
                  (textLower.includes('—Å–æ–≤–µ—Ç—Å–∫–∏–π') && textLower.includes('–∞–∫—Ç—ë—Ä'));

                if (text.length > 80 && isPlaceLike && !isPersonText) {
                  fullText = text;
                  foundTitle = r.title;
                  break;
                }
              }
              if (fullText) break;
            }

            if (!fullText) throw new Error('–°—Ç–∞—Ç—å—è –æ –º–µ—Å—Ç–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');

            wikiBtn.textContent = '‚úçÔ∏è';
            
            let cleaned = fullText.split('\n').join(' ').replace(/[ \t]+/g, ' ').trim();
            cleaned = cleaned
              .replace(/[,.]?\s*–ö–æ–¥ –ö–ê–¢–û[^.]*\.?/gi, '')
              .replace(/[,.]?\s*–ö–ê–¢–û[^.]*\.?/gi, '')
              .replace(/[,.]?\s*–ø–æ—á—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å[^.]*\.?/gi, '')
              .replace(/[,.]?\s*—Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –∫–æ–¥[^.]*\.?/gi, '')
              .replace(/[,.]?\s*[\d]{6,}[^.]*\.?/gi, '')
              .replace(/\([^)]*–Ω–∞—Å–µ–ª–µ–Ω–∏–µ[^)]*\)/gi, '')
              .replace(/\([^)]*–≥–æ–¥[–∞–µ—É][^)]*\)/gi, '')
              .replace(/  +/g, ' ').trim();
            
            const sentences = cleaned.match(/[^.!?]+[.!?]+/g) || [cleaned];
            
            const uniqueSentences = [];
            const seen = new Set();
            for (const s of sentences) {
              const trimmed = s.trim();
              const normalized = trimmed.toLowerCase().replace(/\s+/g, ' ');
              if (!seen.has(normalized) && trimmed.length >= 30) {
                seen.add(normalized);
                uniqueSentences.push(trimmed);
              }
            }
            
            let desc = '';
            let sentCount = 0;
            const maxLength = 400;
            
            for (let i = 0; i < uniqueSentences.length && sentCount < 4; i++) {
              const s = uniqueSentences[i];
              
              if ((desc + s).length > maxLength) {
                if (sentCount === 0 && s.length > 300) {
                  desc = s.slice(0, 297) + '...';
                  break;
                }
                break;
              }
              
              desc += s + ' ';
              sentCount++;
              
              if (sentCount >= 2 && desc.length >= 200 && desc.length <= 350) {
                const nextSent = uniqueSentences[i + 1];
                if (nextSent && (desc + nextSent).length <= maxLength) {
                  continue; 
                } else {
                  break; 
                }
              }
            }
            
            desc = desc.trim();
            
            if (desc.length > 400) {
              desc = desc.slice(0, 397) + '...';
            }
            
            if (!desc) desc = cleaned.slice(0, 300);

            wikiBtn.textContent = 'üíæ';
            const pt = points[p.index];
            const { error } = await sb.from('markers').update({ desc: desc }).eq('id', pt.id);
            if (error) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
            pt.desc = desc;
            map.removeLayer(pt.marker);
            addMarker(pt, p.index);
            loadPointToForm(p.index);
            document.getElementById('pointDesc').value = desc;
            panel.scrollTop = 0;

          } catch(err) {
            alert('–û—à–∏–±–∫–∞ –í–∏–∫–∏: ' + err.message);
          }
          wikiBtn.disabled = false; wikiBtn.textContent = 'üìñ';
        };

        div.appendChild(rqBtn);
        div.appendChild(wikiBtn);
        div.appendChild(del);
        listDiv.appendChild(div);
      });
    }

    async function addOrEditPoint(lat, lng, name = '', desc = '') {
      try {
        if (editIndex >= 0) {
          const existing = points[editIndex];
          const { error } = await sb.from('markers').update({ lat, lng, name, desc }).eq('id', existing.id);
          if (error) {
            console.error('Supabase update error:', error);
            throw error;
          }
          
          map.removeLayer(existing.marker);
          existing.lat = lat;
          existing.lng = lng;
          existing.name = name;
          existing.desc = desc;
          addMarker(existing, editIndex);
          refreshList(searchInput.value.trim());
          clearForm();
        } else {
          const { data, error } = await sb.from('markers').insert([{ lat, lng, name, desc }]).select();
          if (error) {
            console.error('Supabase insert error:', error);
            alert(`–û—à–∏–±–∫–∞ Supabase: ${error.message}\n–ö–æ–¥: ${error.code}\n–î–µ—Ç–∞–ª–∏: ${error.details}`);
            throw error;
          }
          
          const newPoint = normalizePoint(data[0]);
          points.push(newPoint);
          addMarker(newPoint, points.length - 1);
          refreshList(searchInput.value.trim());
        }
      } catch (err) {
        console.error('Full error object:', err);
        if (!err.message?.includes('Supabase:')) {
          alert(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ—á–∫–∏: ${err.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
        }
      }
    }

    function flyToPoint(realIndex) {
      if (points.length === 0) return;
      // clamp with wrap
      if (realIndex < 0) realIndex = points.length - 1;
      if (realIndex >= points.length) realIndex = 0;

      const p = points[realIndex];
      if (!p) return;
      currentIndex = realIndex;
      map.flyTo([p.lat, p.lng], 14, { animate: true, duration: 1.5 });
      setTimeout(() => p.marker && p.marker.openPopup(), 900);
      refreshList(searchInput.value.trim());
    }


    document.getElementById('migrateFromLocal').onclick = async () => {
      try {
        const localData = localStorage.getItem('savedPoints');
        if (!localData) return alert('–í localStorage –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫!');
        
        const oldPoints = JSON.parse(localData);
        if (!Array.isArray(oldPoints) || oldPoints.length === 0) {
          return alert('–í localStorage –Ω–µ—Ç —Ç–æ—á–µ–∫ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞!');
        }
        
        let count = 0;
        for (let p of oldPoints) {
          if (!isNaN(p.lat) && !isNaN(p.lng)) {
            const { error } = await sb.from('markers').insert([{ lat: Number(p.lat), lng: Number(p.lng) }]);
            if (!error) count++;
          }
        }
        
        alert(`–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ ${count} —Ç–æ—á–µ–∫ –≤ Supabase!`);
        await loadPoints();
      } catch (err) {
        console.error('Migration error:', err);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ —Ç–æ—á–µ–∫');
      }
    };

    addBtn.onclick = () => {
      const lat = parseFloat(document.getElementById('pointLat').value);
      const lng = parseFloat(document.getElementById('pointLng').value);
      const name = document.getElementById('pointName').value.trim();
      const desc = document.getElementById('pointDesc').value.trim();
      if (isNaN(lat) || isNaN(lng)) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã!");
      addOrEditPoint(lat, lng, name, desc);
    };

    document.getElementById('bulkWiki').onclick = async () => {
      const pwd = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏–π:');
      if (pwd !== '59872461') return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
      
      if (!confirm('–î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è –∏–∑ –í–∏–∫–∏–ø–µ–¥–∏–∏ –≤—Å–µ–º —Ç–æ—á–∫–∞–º —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏?\n\n–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.')) return;
      
      const pointsWithNames = points.filter(p => p.name && p.name.trim());
      if (pointsWithNames.length === 0) return alert('–ù–µ—Ç —Ç–æ—á–µ–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏!');
      
      let processed = 0;
      let success = 0;
      let failed = 0;
      
      for (const pt of pointsWithNames) {
        processed++;
        console.log(`[${processed}/${pointsWithNames.length}] –û–±—Ä–∞–±–æ—Ç–∫–∞: ${pt.name}`);
        
        if (pt.desc && pt.desc.trim()) {
          console.log(`  ‚è≠ –£–∂–µ –µ—Å—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ`);
          continue;
        }
        
        try {
          const searches = [
            pt.name + ' —Å–µ–ª–æ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω',
            pt.name + ' –≥–æ—Ä–æ–¥ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω',
            pt.name + ' –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω',
            pt.name,
          ];

          let foundDesc = '';

          for (const query of searches) {
            const searchRes = await fetch(
              `https://ru.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*&srlimit=5`
            );
            const searchJson = await searchRes.json();
            const results = searchJson?.query?.search || [];

            for (const r of results) {
              const snippetLower = (r.snippet || '').toLowerCase();
              const isPerson =
                snippetLower.includes('—Ä–æ–¥–∏–ª—Å—è') ||
                snippetLower.includes('—Å–æ–≤–µ—Ç—Å–∫–∏–π') && snippetLower.includes('–∞–∫—Ç—ë—Ä') ||
                snippetLower.includes('–±–∏–æ–≥—Ä–∞—Ñ–∏—è') ||
                snippetLower.includes('–∫–∞–∑–∞—Ö—Å–∫–∏–π –ø–æ–ª–∏—Ç–∏–∫') ||
                snippetLower.includes('–¥–µ–ø—É—Ç–∞—Ç') ||
                /(–∞–∫—Ç—ë—Ä|–ø–µ–≤–µ—Ü|–ø–æ–ª–∏—Ç–∏–∫|—Å–ø–æ—Ä—Ç—Å–º–µ–Ω|—É—á—ë–Ω—ã–π|–ø–∏—Å–∞—Ç–µ–ª—å)/.test(snippetLower);
              if (isPerson) continue;

              const pageRes = await fetch(
                `https://ru.wikipedia.org/w/api.php?action=query&prop=extracts&exsectionformat=plain&explaintext=true&titles=${encodeURIComponent(r.title)}&format=json&origin=*`
              );
              if (!pageRes.ok) continue;
              const pageJson = await pageRes.json();
              const pages = pageJson?.query?.pages || {};
              const page = Object.values(pages)[0];
              const text = (page?.extract || '').trim();

              const textLower = text.toLowerCase();
              const isPlaceLike =
                textLower.includes('–Ω–∞—Å–µ–ª—ë–Ω–Ω—ã–π –ø—É–Ω–∫—Ç') ||
                textLower.includes('—Å–µ–ª–æ') ||
                textLower.includes('–≥–æ—Ä–æ–¥') ||
                textLower.includes('–∞—É–ª') ||
                textLower.includes('—Ä–∞–π–æ–Ω') ||
                textLower.includes('–ø–æ—Å—ë–ª–æ–∫') ||
                textLower.includes('–æ–±–ª–∞—Å—Ç—å') ||
                textLower.includes('—Ä–µ–∫–∞') ||
                textLower.includes('–æ–∑–µ—Ä–æ') ||
                textLower.includes('—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω');

              if (text && isPlaceLike) {
                foundDesc = text;
                break;
              }
            }

            if (foundDesc) break;
            await new Promise(resolve => setTimeout(resolve, 200));
          }

          if (foundDesc) {
            let cleaned = foundDesc.split('\n').join(' ').replace(/[ \t]+/g, ' ').trim();
            cleaned = cleaned
              .replace(/[,.]?\s*–ö–æ–¥ –ö–ê–¢–û[^.]*\.?/gi, '')
              .replace(/[,.]?\s*–ö–ê–¢–û[^.]*\.?/gi, '')
              .replace(/[,.]?\s*–ø–æ—á—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å[^.]*\.?/gi, '')
              .replace(/[,.]?\s*—Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –∫–æ–¥[^.]*\.?/gi, '')
              .replace(/[,.]?\s*[\d]{6,}[^.]*\.?/gi, '')
              .replace(/\([^)]*–Ω–∞—Å–µ–ª–µ–Ω–∏–µ[^)]*\)/gi, '')
              .replace(/\([^)]*–≥–æ–¥[–∞–µ—É][^)]*\)/gi, '')
              .replace(/  +/g, ' ').trim();
            
            const sentences = cleaned.match(/[^.!?]+[.!?]+/g) || [cleaned];
            
            const uniqueSentences = [];
            const seen = new Set();
            for (const s of sentences) {
              const trimmed = s.trim();
              const normalized = trimmed.toLowerCase().replace(/\s+/g, ' ');
              if (!seen.has(normalized) && trimmed.length >= 30) {
                seen.add(normalized);
                uniqueSentences.push(trimmed);
              }
            }
            
            let shortDesc = '';
            let sentCount = 0;
            const maxLength = 400;
            
            for (let i = 0; i < uniqueSentences.length && sentCount < 4; i++) {
              const s = uniqueSentences[i];
              
              if ((shortDesc + s).length > maxLength) {
                if (sentCount === 0 && s.length > 300) {
                  shortDesc = s.slice(0, 297) + '...';
                  break;
                }
                break;
              }
              
              shortDesc += s + ' ';
              sentCount++;
              
              if (sentCount >= 2 && shortDesc.length >= 200 && shortDesc.length <= 350) {
                const nextSent = uniqueSentences[i + 1];
                if (nextSent && (shortDesc + nextSent).length <= maxLength) {
                  continue;
                } else {
                  break;
                }
              }
            }
            
            shortDesc = shortDesc.trim();
            
            if (shortDesc.length > 400) {
              shortDesc = shortDesc.slice(0, 397) + '...';
            }
            
            if (!shortDesc) shortDesc = cleaned.slice(0, 300);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤ Supabase
            const { error } = await sb.from('markers').update({ desc: shortDesc }).eq('id', pt.id);
            if (error) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –ø–∞–º—è—Ç–∏
            pt.desc = shortDesc;
            map.removeLayer(pt.marker);
            const idx = points.indexOf(pt);
            addMarker(pt, idx);
            
            success++;
            console.log(`  ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ (${shortDesc.length} —Å–∏–º–≤–æ–ª–æ–≤)`);
          } else {
            failed++;
            console.log(`  ‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ`);
          }
          
          await new Promise(resolve => setTimeout(resolve, 500));
          
        } catch (err) {
          failed++;
          console.error(`  ‚ùå –û—à–∏–±–∫–∞: ${err.message}`);
        }
      }
      
      refreshList();
      alert(`–ì–æ—Ç–æ–≤–æ!\n\n–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${processed}\n–£—Å–ø–µ—à–Ω–æ: ${success}\n–ù–µ –Ω–∞–π–¥–µ–Ω–æ: ${failed}`);
    };

    document.getElementById('deleteAll').onclick = async () => {
      const pwd = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–æ—á–µ–∫:');
      if (pwd !== '59872461') return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
      if (!confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç–æ—á–∫–∏?")) return;
      try {
        const { error } = await sb.from('markers').delete().neq('id', 0);
        if (error) throw error;
        points.forEach(p => p.marker && map.removeLayer(p.marker));
        points = [];
        refreshList();
      } catch (err) {
        console.error('Error deleting all points:', err);
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫');
      }
    };

    document.getElementById('saveJSON').onclick = () => {
      const data = JSON.stringify(points.map(p => ({ name: p.name, desc: p.desc, lat: p.lat, lng: p.lng })), null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = '–∫–∞—Ä—Ç–∞_ZKO.json'; a.click(); URL.revokeObjectURL(url);
    };

    document.getElementById('importJSON').onchange = async e => {
      const file = e.target.files[0];
      if (!file) return;
      if (prompt('–ü–∞—Ä–æ–ª—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞:') !== '59872461') { e.target.value = ''; return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!'); }
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (!Array.isArray(data)) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON!");
        
        let count = 0;
        for (let p of data) {
          if (!isNaN(p.lat) && !isNaN(p.lng)) {
            await addOrEditPoint(p.lat, p.lng, p.name || '', p.desc || '');
            count++;
            await new Promise(resolve => setTimeout(resolve, 100));
          }
        }
        alert(`–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω! –î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–æ—á–µ–∫: ${count}`);
      } catch (err) {
        console.error('Import error:', err);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ JSON!");
      }
    };

    document.getElementById('importKml').onchange = async e => {
      const file = e.target.files[0];
      if (!file) return;
      if (prompt('–ü–∞—Ä–æ–ª—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞:') !== '59872461') { e.target.value = ''; return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!'); }
      
      try {
        let kmlText = '';
        
        if (file.name.endsWith('.kmz')) {
          const zip = await JSZip.loadAsync(file);
          const kmlFile = Object.keys(zip.files).find(name => name.endsWith('.kml'));
          if (!kmlFile) return alert("–í KMZ –Ω–µ—Ç KML-—Ñ–∞–π–ª–∞!");
          kmlText = await zip.files[kmlFile].async('text');
        } else {
          
          kmlText = await file.text();
        }
        
        const xml = new DOMParser().parseFromString(kmlText, 'text/xml');
        const placemarks = xml.getElementsByTagName('Placemark');
        
        let count = 0;
        for (let p of placemarks) {
          const name = p.getElementsByTagName('name')[0]?.textContent || '';
          const desc = p.getElementsByTagName('description')[0]?.textContent || '';
          const coords = p.getElementsByTagName('coordinates')[0]?.textContent?.trim();
          if (!coords) continue;
          const [lng, lat] = coords.split(',').map(Number);
          if (isNaN(lat) || isNaN(lng)) continue;
          await addOrEditPoint(lat, lng, name, desc);
          count++;
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        alert(`–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω! –î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–æ—á–µ–∫: ${count}`);
      } catch (err) {
        console.error('KML/KMZ import error:', err);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ KML/KMZ —Ñ–∞–π–ª–∞!");
      }
    };

    document.getElementById('selectModeBtn').onclick = () => {
      selectMode = !selectMode;
      document.getElementById('selectModeBtn').textContent = selectMode ? '–û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä' : '–í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ';
      map.getContainer().style.cursor = selectMode ? 'crosshair' : '';
    };

    map.on('click', e => {
      if (selectMode) {
        document.getElementById('pointLat').value = e.latlng.lat.toFixed(6);
        document.getElementById('pointLng').value = e.latlng.lng.toFixed(6);
        selectMode = false;
        document.getElementById('selectModeBtn').textContent = '–í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ';
        map.getContainer().style.cursor = '';
      }
    });

    searchInput.oninput = e => refreshList(e.target.value.trim());

    let routeOrder = []; // array of point indices defining navigation order
    let routePos = 0;    // current position in routeOrder
    let routeMode = false;

    const routeBtn = document.getElementById('routeBtn');
    const routePanel = document.getElementById('routePanel');
    const mainPanel = document.getElementById('mainPanel');

    routeBtn.onclick = () => {
      routeMode = !routeMode;
      routeBtn.classList.toggle('active', routeMode);
      routeBtn.textContent = routeMode ? '‚úï –ó–∞–∫—Ä—ã—Ç—å –º–∞—Ä—à—Ä—É—Ç' : 'üó∫ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç ‚Üê‚Üí';
      routePanel.classList.toggle('active', routeMode);
      mainPanel.classList.toggle('route-hidden', routeMode);
      if (routeMode) renderRoutePanel();
    };

    document.getElementById('routeClearBtn').onclick = () => {
      routeOrder = []; routePos = 0; renderRoutePanel();
    };

    document.getElementById('routeSearch').oninput = e => renderRouteAddList(e.target.value.trim());

    function renderRoutePanel() {
      renderRouteList();
      renderRouteAddList(document.getElementById('routeSearch').value.trim());
    }

    let routeDragSrc = null;

    function renderRouteList() {
      const el = document.getElementById('routeList');
      el.innerHTML = '';
      if (routeOrder.length === 0) {
        el.innerHTML = '<p style="font-size:12px;color:#888;text-align:center;">–ú–∞—Ä—à—Ä—É—Ç –ø—É—Å—Ç</p>';
        return;
      }
      routeOrder.forEach((pi, ri) => {
        const p = points[pi];
        if (!p) return;
        const div = document.createElement('div');
        div.className = 'route-item';
        div.draggable = true;
        div.innerHTML = `<span class="route-num">${ri+1}</span>
          <div class="point-text" style="flex:1;min-width:0;margin:0 4px;">${p.name ? `<b>${p.name}</b>` : `<b>–¢–æ—á–∫–∞ ${pi+1}</b>`}<br><small>${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}</small></div>
          <button class="route-del" title="–£–±—Ä–∞—Ç—å –∏–∑ –º–∞—Ä—à—Ä—É—Ç–∞">‚úï</button>`;

        div.querySelector('.route-del').onclick = () => {
          routeOrder.splice(ri, 1);
          if (routePos >= routeOrder.length) routePos = Math.max(0, routeOrder.length - 1);
          renderRouteList();
        };

        div.addEventListener('dragstart', e => { routeDragSrc = ri; setTimeout(() => div.classList.add('dragging'), 0); });
        div.addEventListener('dragend', () => div.classList.remove('dragging'));
        div.addEventListener('dragover', e => { e.preventDefault(); div.classList.add('drag-over'); });
        div.addEventListener('dragleave', () => div.classList.remove('drag-over'));
        div.addEventListener('drop', e => {
          e.preventDefault(); div.classList.remove('drag-over');
          if (routeDragSrc === null || routeDragSrc === ri) return;
          const moved = routeOrder.splice(routeDragSrc, 1)[0];
          routeOrder.splice(ri, 0, moved);
          routeDragSrc = null;
          renderRouteList();
        });

        el.appendChild(div);
      });
    }

    function renderRouteAddList(filter = '') {
      const el = document.getElementById('routeAddList');
      el.innerHTML = '';
      const lf = filter.toLowerCase();
      points.forEach((p, i) => {
        if (routeOrder.includes(i)) return; // already in route
        const name = p.name || `–¢–æ—á–∫–∞ ${i+1}`;
        if (lf && !name.toLowerCase().includes(lf) && !`${p.lat.toFixed(4)},${p.lng.toFixed(4)}`.includes(lf)) return;
        const div = document.createElement('div');
        div.className = 'route-item';
        div.style.cursor = 'pointer';
        div.innerHTML = `<span style="font-size:16px;flex-shrink:0">Ôºã</span>
          <div class="point-text" style="flex:1;min-width:0;margin-left:4px;">${p.name ? `<b>${p.name}</b>` : `<b>–¢–æ—á–∫–∞ ${i+1}</b>`}<br><small>${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}</small></div>`;
        div.onclick = () => { routeOrder.push(i); renderRoutePanel(); };
        el.appendChild(div);
      });
      if (el.innerHTML === '') el.innerHTML = '<p style="font-size:12px;color:#888;text-align:center;">–í—Å–µ —Ç–æ—á–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>';
    }

    document.getElementById('prevBtn').onclick = () => {
      if (routeMode && routeOrder.length > 0) {
        routePos = routePos <= 0 ? routeOrder.length - 1 : routePos - 1;
        flyToPoint(routeOrder[routePos]);
      } else {
        if (points.length === 0) return;
        const newIdx = currentIndex <= 0 ? points.length - 1 : currentIndex - 1;
        flyToPoint(newIdx);
      }
    };
    document.getElementById('nextBtn').onclick = () => {
      if (routeMode && routeOrder.length > 0) {
        routePos = routePos >= routeOrder.length - 1 ? 0 : routePos + 1;
        flyToPoint(routeOrder[routePos]);
      } else {
        if (points.length === 0) return;
        const newIdx = currentIndex >= points.length - 1 ? 0 : currentIndex + 1;
        flyToPoint(newIdx);
      }
    };


    (function() {
      try {
        const presenceKey = Math.random().toString(36).slice(2);
        const ch = sb.channel('online-presence', { config: { presence: { key: presenceKey } } });
        ch.on('presence', { event: 'sync' }, () => {
          const n = Object.keys(ch.presenceState()).length;
          document.getElementById('onlineCount').textContent = n;
        }).subscribe(async status => {
          if (status === 'SUBSCRIBED') await ch.track({ at: Date.now() });
        });
      } catch(e) {
        document.getElementById('onlineCount').textContent = '‚Äî';
      }
    })();

    // Load points on startup
    loadPoints();
  </script>
</body>
</html>

