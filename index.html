<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–†–µ–¥–∞–∫—Ç–æ—Ä –∫–∞—Ä—Ç—ã –ó–ö–û</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    #panel { position: absolute; top: 10px; left: 10px; z-index: 1000; background: rgba(255,255,255,0.98); padding: 14px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.25); width: 270px; font-family: system-ui, sans-serif; transition: all 0.3s ease; max-height: 85vh; overflow-y: auto; }
    #panel.hidden { opacity: 0; transform: translateX(-320px); pointer-events: none; }
    #toggleArrow { position: absolute; top: 50%; left: 280px; transform: translateY(-50%); background: #007bff; color: white; border: none; border-radius: 0 6px 6px 0; width: 26px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1100; box-shadow: 1px 2px 5px rgba(0,0,0,0.3); font-size: 18px; transition: left 0.3s ease, opacity 0.3s ease; }
    #toggleArrow.hidden { opacity: 0; pointer-events: none; }
    #panel input, #panel textarea, #panel select { width: 100%; margin-bottom: 6px; padding: 6px 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; }
    #panel button { width: 100%; background: #007bff; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; transition: background 0.2s; font-size: 14px; margin-bottom: 5px; }
    #panel button:hover { background: #0056b3; }
    .point-item { display: flex; justify-content: space-between; align-items: center; padding: 6px; border-radius: 6px; margin-bottom: 4px; background: #f2f2f2; cursor: pointer; font-size: 14px; }
    .delete-btn { background: #dc3545; color: white; border: none; border-radius: 5px; padding: 3px 7px; font-size: 13px; cursor: pointer; }
    .leaflet-control-zoom { right: 15px !important; bottom: 80px !important; }
    #mobileArrows { position: absolute; bottom: 20px; right: 20px; display: flex; gap: 10px; z-index: 1200; }
    .nav-btn { background: rgba(0,123,255,0.9); border: none; color: white; width: 46px; height: 46px; border-radius: 50%; font-size: 20px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; }
    .nav-btn:active { background: #0056b3; transform: scale(0.96); }
  </style>
</head>
<body>
  <div id="panel">
    <h3 id="formTitle">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É</h3>
    <label>–¢–∏–ø –∫–∞—Ä—Ç—ã:</label>
    <select id="mapType"><option value="osm">–û–±—ã—á–Ω–∞—è</option><option value="satellite">–°–ø—É—Ç–Ω–∏–∫–æ–≤–∞—è</option></select>
    <input type="text" id="pointName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" />
    <textarea id="pointDesc" rows="2" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
    <input type="file" id="pointPhoto" accept="image/*" />
    <input type="text" id="pointLat" placeholder="–®–∏—Ä–æ—Ç–∞ (lat)" />
    <input type="text" id="pointLng" placeholder="–î–æ–ª–≥–æ—Ç–∞ (lng)" />
    <button id="selectModeBtn">–í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</button>
    <button id="addPoint">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É</button>
    <button id="deleteAll" style="background:#dc3545;">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç–æ—á–∫–∏</button>
    <button id="saveJSON" style="background:#17a2b8;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç—É (JSON)</button>
    <label style="font-size:13px;color:#333;">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ JSON:</label>
    <input type="file" id="importJSON" accept=".json" />
    <label style="font-size:13px;color:#333;">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ KMZ:</label>
    <input type="file" id="importKmz" accept=".kmz" />
    <label style="font-size:13px;color:#333;">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–æ—á–∫–∏ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º:</label>
<label class="switch">
  <input type="checkbox" id="descFilter">
  <span class="slider"></span>
</label>
<style>
.switch {
  position: relative; display: inline-block; width: 46px; height: 24px; margin-bottom: 10px;
}
.switch input { opacity: 0; width: 0; height: 0; }
.slider {
  position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
  background-color: #ccc; transition: 0.3s; border-radius: 24px;
}
.slider:before {
  position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
  background-color: white; transition: 0.3s; border-radius: 50%;
}
input:checked + .slider { background-color: #007bff; }
input:checked + .slider:before { transform: translateX(22px); }
</style>
    <input type="text" id="searchPoints" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–æ—á–∫–∞–º..." style="margin-top:10px;padding:6px;border-radius:6px;border:1px solid #ccc;font-size:14px;"/>
    <div id="pointsList"></div>
  </div>
  <button id="toggleArrow">&lt;</button>
  <div id="map"></div>
  <div id="mobileArrows">
    <button class="nav-btn" id="prevBtn">‚Üê</button>
    <button class="nav-btn" id="nextBtn">‚Üí</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    const satelliteLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}');
    const map = L.map('map', { zoomControl: false, attributionControl: false, layers: [osmLayer] }).setView([50.9, 52.0], 7);
    L.control.zoom({ position: 'bottomright' }).addTo(map);


const panel = document.getElementById('panel');
const arrow = document.getElementById('toggleArrow');

function togglePanel() {
  const hidden = panel.classList.toggle('hidden');
  arrow.textContent = hidden ? '>' : '<';
  arrow.style.left = hidden ? '0px' : '280px';
  arrow.style.opacity = hidden ? '0' : '1';
}


arrow.addEventListener('click', togglePanel);
arrow.addEventListener('touchstart', e => { e.preventDefault(); togglePanel(); });


document.addEventListener('mousemove', e => {
  if (e.clientX < 10 && panel.classList.contains('hidden')) {
    arrow.style.opacity = '1';
  } else if (panel.classList.contains('hidden')) {
    arrow.style.opacity = '0';
  }
});



    document.getElementById("mapType").addEventListener("change", e => {
      map.removeLayer(osmLayer);
      map.removeLayer(satelliteLayer);
      (e.target.value === "satellite" ? satelliteLayer : osmLayer).addTo(map);
    });

    const STORAGE_KEY = 'savedPoints';
    let points = [];
    try {
      const savedPoints = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      points = Array.isArray(savedPoints) ? savedPoints.map(normalizePoint) : [];
    } catch {
      points = [];
    }
    let selectMode = false, currentIndex = -1, editIndex = -1;
    const listDiv = document.getElementById('pointsList');
    const searchInput = document.getElementById('searchPoints');
    const addBtn = document.getElementById('addPoint');
    const descFilter = document.getElementById('descFilter');
    descFilter.addEventListener('change', () => refreshList(searchInput.value.trim()));
    const formTitle = document.getElementById('formTitle');

    function normalizePoint(p) {
      return { name: p.name || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è", desc: p.desc || "", lat: Number(p.lat), lng: Number(p.lng), photo: p.photo || null };
    }

    function addMarker(p, i) {
      const marker = L.marker([p.lat, p.lng]).addTo(map);
      let popup = `<b>${p.name}</b><br>${p.desc || ''}`;
      if (p.photo) popup += `<br><img src="${p.photo}" style="width:180px;margin-top:6px;border-radius:8px;">`;
      marker.bindPopup(popup);
      marker.on("click", () => { flyToPoint(i); loadPointToForm(i); });
      p.marker = marker;
    }

    function loadPointToForm(i) {
      const p = points[i];
      document.getElementById('pointName').value = p.name;
      document.getElementById('pointDesc').value = p.desc;
      document.getElementById('pointLat').value = p.lat;
      document.getElementById('pointLng').value = p.lng;
      editIndex = i;
      addBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è";
      formTitle.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ—á–∫—É";
    }

    function clearForm() {
      document.getElementById('pointName').value = "";
      document.getElementById('pointDesc').value = "";
      document.getElementById('pointLat').value = "";
      document.getElementById('pointLng').value = "";
      document.getElementById('pointPhoto').value = "";
      editIndex = -1;
      addBtn.textContent = "–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É";
      formTitle.textContent = "–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É";
    }

    function saveToLocalStorage() { localStorage.setItem(STORAGE_KEY, JSON.stringify(points.map(normalizePoint))); }

function refreshList(filter = '') {
  listDiv.innerHTML = '';
  const onlyWithDesc = descFilter.checked;
  const lowerFilter = filter.toLowerCase();


  const filteredPoints = points
    .map((p, i) => ({ ...p, index: i })) // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å
    .filter(p => (!onlyWithDesc || p.desc.trim()) && p.name.toLowerCase().includes(lowerFilter));


  points.forEach(p => {
    const visible = filteredPoints.some(fp => fp.lat === p.lat && fp.lng === p.lng);
    if (p.marker) p.marker.setOpacity(visible ? 1 : 0);
  });


  filteredPoints.forEach(p => {
    const div = document.createElement('div');
    div.className = 'point-item';
    div.innerHTML = `<div><b>${p.name}</b><br><small>${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}</small></div>`;
    div.onclick = () => { flyToPoint(p.index); loadPointToForm(p.index); };

    const del = document.createElement('button');
    del.textContent = 'üóë';
    del.className = 'delete-btn';
    del.onclick = e => {
      e.stopPropagation();
      map.removeLayer(p.marker);
      points.splice(p.index, 1);
      saveToLocalStorage();
      refreshList(searchInput.value.trim());
    };

    div.appendChild(del);
    listDiv.appendChild(div);
  });
}


    function addOrEditPoint(p) {
      if (editIndex >= 0) {
        const existing = points[editIndex];
        Object.assign(existing, p);
        map.removeLayer(existing.marker);
        addMarker(existing, editIndex);
        saveToLocalStorage();
        refreshList(searchInput.value.trim());
        clearForm();
      } else {
        const n = normalizePoint(p);
        points.push(n);
        addMarker(n, points.length - 1);
        saveToLocalStorage();
        refreshList(searchInput.value.trim());
      }
    }

function flyToPoint(realIndex) {
  if (points.length === 0) return;

  const onlyWithDesc = descFilter.checked;
  const filterText = searchInput.value.trim().toLowerCase();

  const filtered = points
    .map((p, i) => ({ ...p, i }))
    .filter(p => (!onlyWithDesc || p.desc.trim()) && p.name.toLowerCase().includes(filterText));

  if (filtered.length === 0) return;


  let idx = filtered.findIndex(p => p.i === realIndex);
  if (idx === -1) idx = 0;

  const p = filtered[idx];
  map.flyTo([p.lat, p.lng], 17, { animate: true, duration: 3 });
  setTimeout(() => p.marker.openPopup(), 1500);

  currentIndex = p.i;
}




    document.getElementById('prevBtn').onclick = () => flyToPoint(currentIndex - 1);
    document.getElementById('nextBtn').onclick = () => flyToPoint(currentIndex + 1);

    addBtn.onclick = () => {
      const name = document.getElementById('pointName').value.trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
      const desc = document.getElementById('pointDesc').value.trim();
      const lat = parseFloat(document.getElementById('pointLat').value);
      const lng = parseFloat(document.getElementById('pointLng').value);
      if (isNaN(lat) || isNaN(lng)) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã!");
      const photo = document.getElementById('pointPhoto');
      if (photo.files.length > 0) {
        const reader = new FileReader();
        reader.onload = e => addOrEditPoint({ name, desc, lat, lng, photo: e.target.result });
        reader.readAsDataURL(photo.files[0]);
      } else addOrEditPoint({ name, desc, lat, lng });
    };

    document.getElementById('deleteAll').onclick = () => {
      if (!confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç–æ—á–∫–∏?")) return;
      points.forEach(p => p.marker && map.removeLayer(p.marker));
      points = [];
      saveToLocalStorage();
      refreshList();
    };

    document.getElementById('saveJSON').onclick = () => {
      const data = JSON.stringify(points.map(normalizePoint), null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = '–∫–∞—Ä—Ç–∞_ZKO.json'; a.click(); URL.revokeObjectURL(url);
    };

    document.getElementById('importJSON').onchange = async e => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (!Array.isArray(data)) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON!");
        clearForm();
        points.forEach(p => p.marker && map.removeLayer(p.marker));
        points = [];
        data.forEach(p => addOrEditPoint(p));
        saveToLocalStorage();
        refreshList();
        e.target.value = '';
        alert("–ò–º–ø–æ—Ä—Ç JSON –∑–∞–≤–µ—Ä—à—ë–Ω!");
      } catch {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ JSON!");
      }
    };

    document.getElementById('importKmz').onchange = async e => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        clearForm();
        const zip = await JSZip.loadAsync(file);
        const kmlFile = Object.keys(zip.files).find(name => name.endsWith('.kml'));
        if (!kmlFile) return alert("–í KMZ –Ω–µ—Ç KML-—Ñ–∞–π–ª–∞!");
        const kmlText = await zip.files[kmlFile].async('text');
        const xml = new DOMParser().parseFromString(kmlText, 'text/xml');
        const placemarks = xml.getElementsByTagName('Placemark');
        for (let p of placemarks) {
          const name = p.getElementsByTagName('name')[0]?.textContent || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
          const desc = p.getElementsByTagName('description')[0]?.textContent || '';
          const coords = p.getElementsByTagName('coordinates')[0]?.textContent?.trim();
          if (!coords) continue;
          const [lng, lat] = coords.split(',').map(Number);
          if (isNaN(lat) || isNaN(lng)) continue;
          addOrEditPoint({ name, desc, lat, lng });
        }
        saveToLocalStorage();
        refreshList();
        e.target.value = '';
        alert("–ò–º–ø–æ—Ä—Ç KMZ –∑–∞–≤–µ—Ä—à—ë–Ω!");
      } catch {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ KMZ!");
      }
    };

    searchInput.oninput = e => refreshList(e.target.value.trim());
    points.forEach((p, i) => addMarker(p, i));
    refreshList();
  </script>
</body>
</html>
