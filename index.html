<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ZkoMap Admin ‚Äî v2.6.0</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    #panel { position: absolute; top: 10px; left: 10px; z-index: 1000; background: rgba(255,255,255,0.98); padding: 14px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.25); width: 270px; font-family: system-ui, sans-serif; transition: all 0.3s ease; max-height: 85vh; overflow-y: auto; }
    #panel.hidden { opacity: 0; transform: translateX(-320px); pointer-events: none; }
    #toggleArrow { position: absolute; top: 50%; left: 280px; transform: translateY(-50%); background: #007bff; color: white; border: none; border-radius: 0 6px 6px 0; width: 26px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1100; box-shadow: 1px 2px 5px rgba(0,0,0,0.3); font-size: 18px; transition: left 0.3s ease, opacity 0.3s ease; }
    #toggleArrow.hidden { opacity: 0; pointer-events: none; }
    #panel input, #panel textarea, #panel select { width: 100%; margin-bottom: 6px; padding: 6px 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; }
    #panel button { width: 100%; background: #007bff; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; transition: background 0.2s; font-size: 14px; margin-bottom: 5px; }
    #panel button:hover { background: #0056b3; }
    #panel .delete-btn, #panel .route-del { width: auto !important; padding: 4px 8px; }
    .point-item { display: flex; align-items: center; gap: 4px; padding: 6px; border-radius: 6px; margin-bottom: 4px; background: #f2f2f2; cursor: pointer; font-size: 14px; min-width: 0; }
    .point-item.active { outline: 2px solid #007bff; }
    body.dark .point-item.active { outline: 2px solid #4da3ff; }
    .point-text { flex: 1; min-width: 0; overflow: hidden; }
    .point-text b, .point-text small { display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .delete-btn { background: #dc3545; color: white; border: none; border-radius: 5px; padding: 4px 8px; font-size: 13px; cursor: pointer; flex-shrink: 0; }
    .leaflet-control-zoom { right: 15px !important; bottom: 80px !important; }
    #mobileArrows { position: absolute; bottom: 20px; right: 20px; display: flex; gap: 10px; z-index: 1200; }
    .nav-btn { background: rgba(0,123,255,0.9); border: none; color: white; width: 46px; height: 46px; border-radius: 50%; font-size: 20px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; }
    .nav-btn:active { background: #0056b3; transform: scale(0.96); }
    #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 2000; font-family: system-ui, sans-serif; }

    /* Dark theme */
    #panel { transition: all 0.3s ease, background 0.4s ease, color 0.4s ease; color: #111; }
    #panel input, #panel textarea, #panel select { transition: background 0.4s ease, color 0.4s ease, border-color 0.4s ease; }
    .point-item { transition: background 0.4s ease, color 0.4s ease; }
    body.dark #panel { background: rgba(22,22,30,0.97); color: #e0e0e0; box-shadow: 0 2px 12px rgba(0,0,0,0.6); }
    body.dark #panel input, body.dark #panel textarea, body.dark #panel select { background: #2a2a38; color: #e0e0e0; border-color: #444; }
    body.dark #panel label { color: #bbb; }
    body.dark #panel h3 { color: #fff; }
    body.dark .point-item { background: #2a2a38; color: #e0e0e0; }
    body.dark .point-item:hover { background: #33334a; }
    body.dark #toggleArrow { background: #1e90ff; }

    /* Dark scrollbar */
    body.dark #panel::-webkit-scrollbar { width: 6px; }
    body.dark #panel::-webkit-scrollbar-track { background: #16161e; border-radius: 10px; }
    body.dark #panel::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
    body.dark #panel::-webkit-scrollbar-thumb:hover { background: #666; }

    /* Drag-and-drop */
    .point-item { cursor: grab; }
    .point-item.dragging { opacity: 0.4; cursor: grabbing; }
    .point-item.drag-over { outline: 2px dashed #007bff; background: #d0e8ff; }
    body.dark .point-item.drag-over { background: #1a2a40; outline-color: #4da3ff; }
    .drag-handle { color: #aaa; font-size: 16px; margin-right: 5px; cursor: grab; user-select: none; flex-shrink: 0; }
    body.dark .drag-handle { color: #555; }
    /* Route mode */
    #routePanel { display:none; }
    #routePanel.active { display:block; }
    #mainPanel.route-hidden { display:none; }
    #routeBtn { background: #6f42c1; }
    #routeBtn.active { background: #4a148c; }
    .route-item { display:flex; align-items:center; gap:4px; padding:5px 6px; border-radius:6px; margin-bottom:4px; background:#f2f2f2; font-size:13px; cursor:grab; }
    .route-item.dragging { opacity:0.4; }
    .route-item.drag-over { outline:2px dashed #6f42c1; }
    .route-num { background:#6f42c1; color:#fff; border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:bold; flex-shrink:0; }
    .route-del { background:none; border:none; color:#dc3545; font-size:15px; cursor:pointer; padding:0 2px; flex-shrink:0; margin-left:auto; }
    .route-add-btn { background:#6f42c1; }
    body.dark .route-item { background:#2a2a38; color:#e0e0e0; }
    body.dark .route-item.drag-over { background:#2a1a40; }

    /* Online counter */
    #onlineBadge { display:flex; align-items:center; gap:5px; font-size:12px; color:#555; margin-bottom:8px; }
    #onlineDot { width:8px; height:8px; border-radius:50%; background:#28a745; animation:blink 2s infinite; flex-shrink:0; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.35} }
    body.dark #onlineBadge { color:#aaa; }

    /* Wiki button */
    .wiki-btn { background:#f8a100 !important; color:#fff; border:none; border-radius:4px; padding:3px 7px; font-size:12px; cursor:pointer; flex-shrink:0; width:auto !important; }
    .wiki-btn:disabled { opacity:.5; cursor:default; }

    /* Route quick button */
    .route-q-btn { background:#6f42c1 !important; color:#fff; border:none; border-radius:5px; padding:4px 7px; font-size:12px; cursor:pointer; flex-shrink:0; width:auto !important; }

    /* Admin panel */
    #adminPanel { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; width:90%; max-width:800px; max-height:80vh; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.3); z-index:3000; overflow:hidden; }
    #adminPanel.active { display:flex; flex-direction:column; }
    #adminHeader { display:flex; justify-content:space-between; align-items:center; padding:15px 20px; background:#007bff; color:white; }
    #adminClose { background:none; border:none; color:white; font-size:24px; cursor:pointer; padding:0; width:30px; }
    #adminContent { flex:1; overflow-y:auto; padding:20px; }
    .visitor-item { padding:12px; border-bottom:1px solid #eee; font-size:14px; }
    .visitor-item:hover { background:#f5f5f5; }
    .visitor-ip { font-weight:bold; color:#007bff; }
    .visitor-meta { color:#666; font-size:12px; margin-top:4px; }
    #adminBadge { position:fixed; bottom:80px; left:20px; background:#dc3545; color:white; padding:8px 12px; border-radius:20px; font-size:12px; cursor:pointer; z-index:1500; box-shadow:0 2px 6px rgba(0,0,0,0.3); }
    body.dark #adminPanel { background:#1a1a24; color:#e0e0e0; }
    body.dark #adminHeader { background:#1e90ff; }
    body.dark .visitor-item { border-bottom-color:#333; }
    body.dark .visitor-item:hover { background:#2a2a38; }
    body.dark .visitor-meta { color:#aaa; }
  </style>
</head>
<body>
  <script>
    const correctPassword = '59872010';
    const enteredPassword = prompt('üîê –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏:');
    if (enteredPassword !== correctPassword) {
      document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:system-ui;font-size:24px;color:#dc3545;">‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>';
      throw new Error('Access denied');
    }
  </script>
  <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ—á–µ–∫...</div>
  <div id="panel">
    <div id="onlineBadge"><span id="onlineDot"></span><span id="onlineCount">...</span> –æ–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å</div>
    <h3 id="formTitle">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É</h3>
    <label>–¢–∏–ø –∫–∞—Ä—Ç—ã:</label>
    <select id="mapType"><option value="osm">–û–±—ã—á–Ω–∞—è</option><option value="satellite">–°–ø—É—Ç–Ω–∏–∫–æ–≤–∞—è</option></select>
    <input type="text" id="pointLat" placeholder="–®–∏—Ä–æ—Ç–∞ (lat)" />
    <input type="text" id="pointLng" placeholder="–î–æ–ª–≥–æ—Ç–∞ (lng)" />
    <input type="text" id="pointName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
    <div style="display:flex;gap:4px;margin-bottom:6px;">
      <textarea id="pointDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="2" style="resize:vertical;flex:1;margin-bottom:0;"></textarea>
      <button id="autoWikiBtn" style="width:auto !important;padding:6px 10px;margin-bottom:0;background:#f8a100;font-size:20px;" title="–ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–∑ –í–∏–∫–∏–ø–µ–¥–∏–∏">üìñ</button>
    </div>
    <button id="selectModeBtn">–í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</button>
    <button id="addPoint">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É</button>
    <button id="migrateFromLocal" style="background:#28a745;">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∏–∑ localStorage</button>
    <button id="bulkWiki" style="background:#f8a100;">üìñ –î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è –≤—Å–µ–º (–í–∏–∫–∏–ø–µ–¥–∏—è)</button>
    <button id="autoGenBtn" style="background:#10b981;">üó∫Ô∏è –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ—á–µ–∫ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞</button>
    <button id="deleteAll" style="background:#dc3545;">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç–æ—á–∫–∏</button>
    <button id="saveJSON" style="background:#17a2b8;">–≠–∫—Å–ø–æ—Ä—Ç –≤ JSON</button>
    <label style="font-size:13px;color:#333;">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ JSON:</label>
    <input type="file" id="importJSON" accept=".json" />
    <label style="font-size:13px;color:#333;">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ KML/KMZ:</label>
    <input type="file" id="importKml" accept=".kml,.kmz" />
    <input type="text" id="searchPoints" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º..." style="margin-top:10px;padding:6px;border-radius:6px;border:1px solid #ccc;font-size:14px;"/>
    <button id="routeBtn" style="background:#6f42c1;margin-top:6px;">üó∫ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç ‚Üê‚Üí</button>
    <div id="mainPanel">
      <div id="pointsList"></div>
    </div>
    <div id="routePanel">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
        <b style="font-size:13px;">–ü–æ—Ä—è–¥–æ–∫ –º–∞—Ä—à—Ä—É—Ç–∞</b>
        <button id="routeClearBtn" style="background:#dc3545;width:auto;padding:3px 8px;font-size:12px;">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
      <p style="font-size:12px;color:#888;margin:0 0 6px;">–ü–µ—Ä–µ—Ç–∞—â–∏ —Ç–æ—á–∫–∏ —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫. –°—Ç—Ä–µ–ª–∫–∏ ‚Üê ‚Üí –±—É–¥—É—Ç —Å–ª–µ–¥–æ–≤–∞—Ç—å —ç—Ç–æ–º—É –º–∞—Ä—à—Ä—É—Ç—É.</p>
      <div id="routeList"></div>
      <div id="routeAddArea">
        <p style="font-size:12px;color:#888;margin:4px 0 4px;">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É –≤ –º–∞—Ä—à—Ä—É—Ç:</p>
        <input type="text" id="routeSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." style="margin-bottom:4px;"/>
        <div id="routeAddList"></div>
      </div>
    </div>
  </div>
  <button id="toggleArrow">&lt;</button>
  <div id="map"></div>
  <div id="mobileArrows">
    <button class="nav-btn" id="prevBtn">‚Üê</button>
    <button class="nav-btn" id="nextBtn">‚Üí</button>
  </div>

  <div id="adminBadge">üîê –ê–¥–º–∏–Ω</div>

  <div id="adminPanel">
    <div id="adminHeader">
      <h3 style="margin:0;">–ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ —Å–∞–π—Ç–∞</h3>
      <button id="adminClose">√ó</button>
    </div>
    <div id="adminContent">
      <p style="color:#666;font-size:13px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
    </div>
  </div>

  
  <div id="autoGenModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:5000; align-items:center; justify-content:center;">
    <div style="background:white; border-radius:12px; padding:24px; width:90%; max-width:500px; box-shadow:0 8px 32px rgba(0,0,0,0.4);">
      <h3 style="margin:0 0 16px; font-size:18px;">üó∫Ô∏è –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ—á–µ–∫ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞</h3>
      
      <label style="display:block; margin-bottom:12px;">
        <input type="checkbox" id="autoGenAll" style="margin-right:8px; width:auto;"/>
        <span style="font-weight:600; font-size:13px;">–î–æ–±–∞–≤–∏—Ç—å –í–°–ï —Ç–æ—á–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏</span>
      </label>
      
      <div id="countWrap">
        <label style="display:block; margin-bottom:6px; font-weight:600; font-size:13px;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ (–µ—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ "–≤—Å–µ"):</label>
        <input type="number" id="autoGenCount" min="1" max="10000" value="50" style="width:100%; padding:10px; border:2px solid #e5e7eb; border-radius:8px; margin-bottom:12px; font-size:14px;"/>
      </div>
      
      <label style="display:block; margin-bottom:6px; font-weight:600; font-size:13px;">–û–±–ª–∞—Å—Ç—å:</label>
      <select id="autoGenRegion" style="width:100%; padding:10px; border:2px solid #e5e7eb; border-radius:8px; margin-bottom:16px; font-size:14px;">
        <option value="all">–í–µ—Å—å –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω</option>
        <option value="zko">–ó–∞–ø–∞–¥–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
        <option value="aktobe">–ê–∫—Ç—é–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
        <option value="atyrau">–ê—Ç—ã—Ä–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
        <option value="mangystau">–ú–∞–Ω–≥–∏—Å—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
        <option value="karaganda">–ö–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
        <option value="kostanay">–ö–æ—Å—Ç–∞–Ω–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
        <option value="pavlodar">–ü–∞–≤–ª–æ–¥–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
        <option value="sko">–°–µ–≤–µ—Ä–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
        <option value="vko">–í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
        <option value="almaty">–ê–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
        <option value="zhambyl">–ñ–∞–º–±—ã–ª—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
        <option value="turkestan">–¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
        <option value="kyzylorda">–ö—ã–∑—ã–ª–æ—Ä–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
        <option value="akmola">–ê–∫–º–æ–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
      </select>
      
      <div style="display:flex; gap:8px;">
        <button id="autoGenStart" style="flex:1; background:#10b981; color:white; border:none; padding:12px; border-radius:8px; font-weight:600; cursor:pointer;">–ù–∞—á–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é</button>
        <button id="autoGenCancel" style="flex:1; background:#6b7280; color:white; border:none; padding:12px; border-radius:8px; font-weight:600; cursor:pointer;">–û—Ç–º–µ–Ω–∞</button>
      </div>
      
      <div id="autoGenProgress" style="display:none; margin-top:16px; padding:12px; background:#f3f4f6; border-radius:8px;">
        <div style="font-size:13px; color:#374151; margin-bottom:4px;">–ü—Ä–æ–≥—Ä–µ—Å—Å: <span id="autoGenCurrent">0</span>/<span id="autoGenTotal">0</span></div>
        <div style="height:6px; background:#e5e7eb; border-radius:3px; overflow:hidden;">
          <div id="autoGenBar" style="height:100%; background:#10b981; width:0%; transition:width 0.3s;"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Supabase setup
    const { createClient } = supabase;
    const supabaseUrl = 'https://diniabtxchgtbcfldwib.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpbmlhYnR4Y2hndGJjZmxkd2liIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MTI1NTIsImV4cCI6MjA4NjQ4ODU1Mn0.fWuFphXouWK35E_qNe6AbokMT-pXeSHodoga1UwYP6c';
    const sb = createClient(supabaseUrl, supabaseKey);

    // Track visitor
    let sessionId = null;
    
    async function trackVisitor() {
      try {
        const ua = navigator.userAgent;
        let device = 'Desktop';
        let browser = 'Unknown';
        let os = 'Unknown';

        // Detect device
        if (/mobile/i.test(ua)) device = 'Mobile';
        else if (/tablet|ipad/i.test(ua)) device = 'Tablet';

        // Detect browser
        if (ua.indexOf('Firefox') > -1) browser = 'Firefox';
        else if (ua.indexOf('SamsungBrowser') > -1) browser = 'Samsung Browser';
        else if (ua.indexOf('Opera') > -1 || ua.indexOf('OPR') > -1) browser = 'Opera';
        else if (ua.indexOf('Trident') > -1) browser = 'IE';
        else if (ua.indexOf('Edge') > -1) browser = 'Edge';
        else if (ua.indexOf('Chrome') > -1) browser = 'Chrome';
        else if (ua.indexOf('Safari') > -1) browser = 'Safari';

        // Detect OS
        if (ua.indexOf('Windows') > -1) os = 'Windows';
        else if (ua.indexOf('Mac') > -1) os = 'MacOS';
        else if (ua.indexOf('Linux') > -1) os = 'Linux';
        else if (ua.indexOf('Android') > -1) os = 'Android';
        else if (ua.indexOf('iOS') > -1 || ua.indexOf('iPhone') > -1 || ua.indexOf('iPad') > -1) os = 'iOS';

        // Get IP (using ipify API)
        let ip = 'Unknown';
        try {
          const ipRes = await fetch('https://api.ipify.org?format=json');
          const ipData = await ipRes.json();
          ip = ipData.ip;
        } catch {}

        // Save to Supabase and get session ID
        const { data, error } = await sb.from('visitor_logs').insert([{
          ip,
          user_agent: ua,
          device,
          browser,
          os,
          last_seen: new Date().toISOString()
        }]).select();
        
        if (data && data[0]) {
          sessionId = data[0].id;
          // Update heartbeat every 30 seconds
          setInterval(updateHeartbeat, 30000);
        }
      } catch (err) {
        console.error('Tracking error:', err);
      }
    }

    async function updateHeartbeat() {
      if (!sessionId) return;
      try {
        await sb.from('visitor_logs').update({ 
          last_seen: new Date().toISOString() 
        }).eq('id', sessionId);
      } catch (err) {
        console.error('Heartbeat error:', err);
      }
    }

    // Admin panel functions
    document.getElementById('adminBadge').onclick = async () => {
      const panel = document.getElementById('adminPanel');
      panel.classList.add('active');
      await loadAdminData();
    };

    async function loadAdminData() {
      try {
        const { data, error } = await sb.from('visitor_logs').select('*').order('visited_at', { ascending: false }).limit(200);
        if (error) throw error;

        const content = document.getElementById('adminContent');
        if (data.length === 0) {
          content.innerHTML = '<p style="color:#999;">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π</p>';
          return;
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ (–ø–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å < 2 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥)
        const now = new Date();
        const activeSessions = data.filter(v => {
          if (!v.last_seen) return false;
          const lastSeen = new Date(v.last_seen);
          const diff = (now - lastSeen) / 1000; // seconds
          return diff < 120; // 2 minutes
        });

        let html = `
          <div style="display:flex;gap:20px;margin-bottom:15px;flex-wrap:wrap;">
            <div style="background:#28a745;color:white;padding:10px 15px;border-radius:8px;">
              <div style="font-size:24px;font-weight:bold;">${activeSessions.length}</div>
              <div style="font-size:12px;">üü¢ –û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å</div>
            </div>
            <div style="background:#007bff;color:white;padding:10px 15px;border-radius:8px;">
              <div style="font-size:24px;font-weight:bold;">${data.length}</div>
              <div style="font-size:12px;">üìä –í—Å–µ–≥–æ –≤–∏–∑–∏—Ç–æ–≤</div>
            </div>
          </div>
        `;

        if (activeSessions.length > 0) {
          html += '<h4 style="margin:15px 0 10px;color:#28a745;">üü¢ –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ–π—á–∞—Å:</h4>';
          activeSessions.forEach(v => {
            const lastSeen = new Date(v.last_seen);
            const secondsAgo = Math.floor((now - lastSeen) / 1000);
            const timeAgo = secondsAgo < 60 ? `${secondsAgo} —Å–µ–∫ –Ω–∞–∑–∞–¥` : `${Math.floor(secondsAgo / 60)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            
            html += `
              <div class="visitor-item" style="border-left:3px solid #28a745;">
                <div class="visitor-ip">üü¢ ${v.ip}</div>
                <div class="visitor-meta">
                  üì± ${v.device} | üåç ${v.browser} | üíª ${v.os}<br>
                  ‚è± ${timeAgo}
                </div>
              </div>
            `;
          });
        }

        html += '<h4 style="margin:15px 0 10px;">üìú –ò—Å—Ç–æ—Ä–∏—è –≤–∏–∑–∏—Ç–æ–≤:</h4>';
        data.forEach(v => {
          const date = new Date(v.visited_at).toLocaleString('ru-RU');
          const isActive = activeSessions.includes(v);
          
          html += `
            <div class="visitor-item" style="${isActive ? 'opacity:0.5;' : ''}">
              <div class="visitor-ip">üåê ${v.ip}</div>
              <div class="visitor-meta">
                üì± ${v.device} | üåç ${v.browser} | üíª ${v.os}<br>
                üïê ${date}
              </div>
            </div>
          `;
        });
        content.innerHTML = html;
      } catch (err) {
        document.getElementById('adminContent').innerHTML = `<p style="color:red;">–û—à–∏–±–∫–∞: ${err.message}</p>`;
      }
    }

    document.getElementById('adminClose').onclick = () => {
      document.getElementById('adminPanel').classList.remove('active');
    };

    // Auto-refresh admin panel every 10 seconds if open
    setInterval(() => {
      if (document.getElementById('adminPanel').classList.contains('active')) {
        loadAdminData();
      }
    }, 10000);

    // Track on page load
    trackVisitor();


    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      noWrap: true,
      bounds: [[-90, -180], [90, 180]]
    });
    const satelliteLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
      noWrap: true,
      bounds: [[-90, -180], [90, 180]]
    });
    const map = L.map('map', { 
      zoomControl: false, 
      attributionControl: false,
      worldCopyJump: false,
      maxBounds: [[-90, -180], [90, 180]],
      maxBoundsViscosity: 1.0,
      layers: [osmLayer] 
    }).setView([50.9, 52.0], 7);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    const panel = document.getElementById('panel');
    const arrow = document.getElementById('toggleArrow');

    function togglePanel() {
      const hidden = panel.classList.toggle('hidden');
      arrow.textContent = hidden ? '>' : '<';
      arrow.style.left = hidden ? '0px' : '280px';
      arrow.style.opacity = hidden ? '0' : '1';
    }

    arrow.addEventListener('click', togglePanel);
    arrow.addEventListener('touchstart', e => { e.preventDefault(); togglePanel(); });

    document.addEventListener('mousemove', e => {
      if (e.clientX < 10 && panel.classList.contains('hidden')) {
        arrow.style.opacity = '1';
      } else if (panel.classList.contains('hidden')) {
        arrow.style.opacity = '0';
      }
    });

    document.getElementById("mapType").addEventListener("change", e => {
      map.removeLayer(osmLayer);
      map.removeLayer(satelliteLayer);
      if (e.target.value === "satellite") {
        satelliteLayer.addTo(map);
        document.body.classList.add('dark');
      } else {
        osmLayer.addTo(map);
        document.body.classList.remove('dark');
      }
    });

    let points = [];
    let selectMode = false, currentIndex = -1, editIndex = -1;

    document.getElementById('autoWikiBtn').onclick = async () => {
      const name = document.getElementById('pointName').value.trim();
      if (!name) return;
      const btn = document.getElementById('autoWikiBtn');
      btn.disabled = true; btn.textContent = 'üîç';
      try {
        const searches = [name + ' —Å–µ–ª–æ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω', name + ' –≥–æ—Ä–æ–¥ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω', name + ' –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω', name];
        let foundDesc = '';
        for (const query of searches) {
          const searchRes = await fetch(`https://ru.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*&srlimit=5`);
          const searchJson = await searchRes.json();
          const results = searchJson?.query?.search || [];
          for (const r of results) {
            const snippetLower = (r.snippet || '').toLowerCase();
            if (snippetLower.includes('—Ä–æ–¥–∏–ª—Å—è') || snippetLower.includes('–±–∏–æ–≥—Ä–∞—Ñ–∏—è') || /(–∞–∫—Ç—ë—Ä|–ø–µ–≤–µ—Ü|–ø–æ–ª–∏—Ç–∏–∫)/.test(snippetLower)) continue;
            const pageRes = await fetch(`https://ru.wikipedia.org/w/api.php?action=query&prop=extracts&exintro=true&explaintext=true&titles=${encodeURIComponent(r.title)}&format=json&origin=*`);
            if (!pageRes.ok) continue;
            const pageJson = await pageRes.json();
            const pages = pageJson?.query?.pages || {};
            const page = Object.values(pages)[0];
            const text = (page?.extract || '').trim();
            const textLower = text.toLowerCase();
            if (text && (textLower.includes('—Å–µ–ª–æ') || textLower.includes('–≥–æ—Ä–æ–¥') || textLower.includes('—Ä–∞–π–æ–Ω') || textLower.includes('—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω'))) {
              foundDesc = text; break;
            }
          }
          if (foundDesc) break;
          await new Promise(r => setTimeout(r, 200));
        }
        if (foundDesc) {
          const shortened = foundDesc.length > 400 ? foundDesc.substring(0, 397) + '...' : foundDesc;
          document.getElementById('pointDesc').value = shortened;
        }
      } catch (err) { console.error('Wiki error:', err); }
      btn.disabled = false; btn.textContent = 'üìñ';
    };
    const listDiv = document.getElementById('pointsList');
    const searchInput = document.getElementById('searchPoints');
    const addBtn = document.getElementById('addPoint');
    const formTitle = document.getElementById('formTitle');

    function normalizePoint(p) {
      return { id: p.id, lat: Number(p.lat), lng: Number(p.lng), name: p.name || '', desc: p.desc || '' };
    }

    function addMarker(p, i) {
      const marker = L.marker([p.lat, p.lng]).addTo(map);
      const title = p.name ? `<b>${p.name}</b>` : `<b>–¢–æ—á–∫–∞ ${i + 1}</b>`;
      const descLine = p.desc ? `<br><i>${p.desc}</i>` : '';
      const popup = `${title}${descLine}`;
      marker.bindPopup(popup);
      marker.on("click", () => { flyToPoint(i); loadPointToForm(i); });
      p.marker = marker;
    }

    function loadPointToForm(i) {
      const p = points[i];
      document.getElementById('pointLat').value = p.lat;
      document.getElementById('pointLng').value = p.lng;
      document.getElementById('pointName').value = p.name || '';
      document.getElementById('pointDesc').value = p.desc || '';
      editIndex = i;
      addBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è";
      formTitle.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ—á–∫—É";
    }

    function clearForm() {
      document.getElementById('pointLat').value = "";
      document.getElementById('pointLng').value = "";
      document.getElementById('pointName').value = "";
      document.getElementById('pointDesc').value = "";
      editIndex = -1;
      addBtn.textContent = "–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É";
      formTitle.textContent = "–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É";
    }

    // Load points from Supabase
    async function loadPoints() {
      try {
        const { data, error } = await sb.from('markers').select('*');
        if (error) throw error;
        
        points.forEach(p => p.marker && map.removeLayer(p.marker));
        points = [];
        
        data.forEach((p, i) => {
          const normalized = normalizePoint(p);
          points.push(normalized);
          addMarker(normalized, i);
        });
        
        if (points.length > 0) currentIndex = 0;
        refreshList();
        document.getElementById('loading').style.display = 'none';
      } catch (err) {
        console.error('Error loading points:', err);
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ—á–µ–∫ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö');
        document.getElementById('loading').style.display = 'none';
      }
    }

    let dragSrcIndex = null;

    function refreshList(filter = '') {
      listDiv.innerHTML = '';
      const lowerFilter = filter.toLowerCase();

      const filteredPoints = points
        .map((p, i) => ({ ...p, index: i }))
        .filter(p => {
          const coords = `${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}`;
          const name = (p.name || '').toLowerCase();
          return coords.includes(lowerFilter) || name.includes(lowerFilter);
        });

      points.forEach(p => {
        const visible = filteredPoints.some(fp => fp.lat === p.lat && fp.lng === p.lng);
        if (p.marker) p.marker.setOpacity(visible ? 1 : 0);
      });

      filteredPoints.forEach(p => {
        const div = document.createElement('div');
        div.className = 'point-item' + (p.index === currentIndex ? ' active' : '');
        div.draggable = true;
        div.dataset.index = p.index;

        const label = p.name ? `<b>${p.name}</b>` : `<b>–¢–æ—á–∫–∞ ${p.index + 1}</b>`;
        div.innerHTML = `<span class="drag-handle" title="–ü–µ—Ä–µ—Ç–∞—â–∏ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏">‚†ø</span><div class="point-text">${label}<br><small>${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}</small></div>`;
        div.onclick = () => { flyToPoint(p.index); loadPointToForm(p.index); };

        div.addEventListener('dragstart', e => {
          dragSrcIndex = p.index;
          setTimeout(() => div.classList.add('dragging'), 0);
          e.dataTransfer.effectAllowed = 'move';
        });
        div.addEventListener('dragend', () => div.classList.remove('dragging'));
        div.addEventListener('dragover', e => { e.preventDefault(); div.classList.add('drag-over'); });
        div.addEventListener('dragleave', () => div.classList.remove('drag-over'));
        div.addEventListener('drop', e => {
          e.preventDefault();
          div.classList.remove('drag-over');
          if (dragSrcIndex === null || dragSrcIndex === p.index) return;
          const moved = points.splice(dragSrcIndex, 1)[0];
          points.splice(p.index, 0, moved);
          dragSrcIndex = null;
          refreshList(searchInput.value.trim());
        });

        const del = document.createElement('button');
        del.textContent = 'üóë';
        del.className = 'delete-btn';
        del.onclick = async e => {
          e.stopPropagation();
          const pwd = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:');
          if (pwd !== '59872461') return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
          try {
            const { error } = await sb.from('markers').delete().eq('id', p.id);
            if (error) throw error;
            map.removeLayer(p.marker);
            points.splice(p.index, 1);
            refreshList(searchInput.value.trim());
          } catch (err) {
            console.error('Error deleting point:', err);
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ—á–∫–∏');
          }
        };

        // üó∫ Quick add to route
        const rqBtn = document.createElement('button');
        rqBtn.textContent = 'üó∫';
        rqBtn.className = 'route-q-btn';
        rqBtn.title = '–î–æ–±–∞–≤–∏—Ç—å –≤ –º–∞—Ä—à—Ä—É—Ç';
        rqBtn.onclick = e => {
          e.stopPropagation();
          if (!routeOrder.includes(p.index)) routeOrder.push(p.index);
          if (routeMode) renderRoutePanel();
        };

        // üìñ Wiki button
        const wikiBtn = document.createElement('button');
        wikiBtn.textContent = 'üìñ';
        wikiBtn.className = 'wiki-btn';
        wikiBtn.title = '–û–ø–∏—Å–∞–Ω–∏–µ –∏–∑ –í–∏–∫–∏–ø–µ–¥–∏–∏';
        wikiBtn.onclick = async e => {
          e.stopPropagation();
          if (!p.name) return alert('–£ —Ç–æ—á–∫–∏ –Ω–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –í–∏–∫–∏');
          wikiBtn.disabled = true; wikiBtn.textContent = 'üîç';
          try {
            // Step 1: Search Wikipedia ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º —É—Ç–æ—á–Ω–µ–Ω–∏—è —á—Ç–æ —ç—Ç–æ –º–µ—Å—Ç–æ
            const searches = [
              p.name + ' —Å–µ–ª–æ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω',
              p.name + ' –≥–æ—Ä–æ–¥ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω',
              p.name + ' –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω',
              p.name,
            ];

            let fullText = '';
            let foundTitle = '';

            for (const query of searches) {
              const searchRes = await fetch(
                `https://ru.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*&srlimit=5`
              );
              const searchJson = await searchRes.json();
              const results = searchJson?.query?.search || [];

              for (const r of results) {
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç–∞—Ç—å–∏ –∫–æ—Ç–æ—Ä—ã–µ —è–≤–Ω–æ –ø—Ä–æ –ª—é–¥–µ–π
                const titleLower = r.title.toLowerCase();
                const snippetLower = (r.snippet || '').toLowerCase();
                const isPerson =
                  snippetLower.includes('—Ä–æ–¥–∏–ª—Å—è') ||
                  snippetLower.includes('—Å–æ–≤–µ—Ç—Å–∫–∏–π') && snippetLower.includes('–∞–∫—Ç—ë—Ä') ||
                  snippetLower.includes('–±–∏–æ–≥—Ä–∞—Ñ–∏—è') ||
                  snippetLower.includes('–∫–∞–∑–∞—Ö—Å–∫–∏–π –ø–æ–ª–∏—Ç–∏–∫') ||
                  snippetLower.includes('–¥–µ–ø—É—Ç–∞—Ç') ||
                  /(–∞–∫—Ç—ë—Ä|–ø–µ–≤–µ—Ü|–ø–æ–ª–∏—Ç–∏–∫|—Å–ø–æ—Ä—Ç—Å–º–µ–Ω|—É—á—ë–Ω—ã–π|–ø–∏—Å–∞—Ç–µ–ª—å)/.test(snippetLower);
                if (isPerson) continue;

                // –ü–æ–ª—É—á–∞–µ–º –ë–û–õ–¨–®–ï —Ç–µ–∫—Å—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–Ω–µ —Ç–æ–ª—å–∫–æ intro, –∞ –ø–µ—Ä–≤—É—é —Å–µ–∫—Ü–∏—é —Ü–µ–ª–∏–∫–æ–º)
                const pageRes = await fetch(
                  `https://ru.wikipedia.org/w/api.php?action=query&prop=extracts&exsectionformat=plain&explaintext=true&titles=${encodeURIComponent(r.title)}&format=json&origin=*`
                );
                if (!pageRes.ok) continue;
                const pageJson = await pageRes.json();
                const pages = pageJson?.query?.pages || {};
                const page = Object.values(pages)[0];
                const text = (page?.extract || '').trim();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–µ–∫—Å—Ç –ø—Ä–æ –º–µ—Å—Ç–æ, –∞ –Ω–µ —á–µ–ª–æ–≤–µ–∫–∞
                const textLower = text.toLowerCase();
                const isPlaceLike =
                  textLower.includes('–Ω–∞—Å–µ–ª—ë–Ω–Ω—ã–π –ø—É–Ω–∫—Ç') ||
                  textLower.includes('—Å–µ–ª–æ') ||
                  textLower.includes('–≥–æ—Ä–æ–¥') ||
                  textLower.includes('–∞—É–ª') ||
                  textLower.includes('—Ä–∞–π–æ–Ω') ||
                  textLower.includes('–æ–±–ª–∞—Å—Ç—å') ||
                  textLower.includes('—Ä–µ–∫–∞') ||
                  textLower.includes('–æ–∑–µ—Ä–æ') ||
                  textLower.includes('—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω') ||
                  textLower.includes('–Ω–∞—Ö–æ–¥–∏—Ç—Å—è') ||
                  textLower.includes('–Ω–∞—Å–µ–ª–µ–Ω–∏–µ');
                const isPersonText =
                  textLower.includes('—Ä–æ–¥–∏–ª—Å—è') ||
                  textLower.includes('—Ä–æ–¥–∏–ª–∞—Å—å') ||
                  (textLower.includes('—Å–æ–≤–µ—Ç—Å–∫–∏–π') && textLower.includes('–∞–∫—Ç—ë—Ä'));

                if (text.length > 80 && isPlaceLike && !isPersonText) {
                  fullText = text;
                  foundTitle = r.title;
                  break;
                }
              }
              if (fullText) break;
            }

            if (!fullText) throw new Error('–°—Ç–∞—Ç—å—è –æ –º–µ—Å—Ç–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');

            // Step 2: –£–º–Ω–æ–µ —Å–∂–∞—Ç–∏–µ - —É–±–∏—Ä–∞–µ–º –ø–æ–≤—Ç–æ—Ä—ã –∏ –±–µ—Ä—ë–º –†–ê–ó–ù–£–Æ –∏–Ω—Ñ—É
            wikiBtn.textContent = '‚úçÔ∏è';
            
            // –ß–∏—Å—Ç–∏–º —Ç–µ–∫—Å—Ç –æ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
            let cleaned = fullText.split('\n').join(' ').replace(/[ \t]+/g, ' ').trim();
            cleaned = cleaned
              .replace(/[,.]?\s*–ö–æ–¥ –ö–ê–¢–û[^.]*\.?/gi, '')
              .replace(/[,.]?\s*–ö–ê–¢–û[^.]*\.?/gi, '')
              .replace(/[,.]?\s*–ø–æ—á—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å[^.]*\.?/gi, '')
              .replace(/[,.]?\s*—Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –∫–æ–¥[^.]*\.?/gi, '')
              .replace(/[,.]?\s*[\d]{6,}[^.]*\.?/gi, '')
              .replace(/\([^)]*–Ω–∞—Å–µ–ª–µ–Ω–∏–µ[^)]*\)/gi, '')
              .replace(/\([^)]*–≥–æ–¥[–∞–µ—É][^)]*\)/gi, '')
              .replace(/  +/g, ' ').trim();
            
            // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
            const sentences = cleaned.match(/[^.!?]+[.!?]+/g) || [cleaned];
            
            // –£–ë–ò–†–ê–ï–ú –î–£–ë–õ–ò–ö–ê–¢–´ –∏ –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
            const uniqueSentences = [];
            const seen = new Set();
            for (const s of sentences) {
              const trimmed = s.trim();
              const normalized = trimmed.toLowerCase().replace(/\s+/g, ' ');
              // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ (< 30 —Å–∏–º–≤–æ–ª–æ–≤)
              if (!seen.has(normalized) && trimmed.length >= 30) {
                seen.add(normalized);
                uniqueSentences.push(trimmed);
              }
            }
            
            // –£–ú–ù–û–ï –°–ñ–ê–¢–ò–ï: –±–µ—Ä—ë–º 2-4 —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ø–µ—Ä–≤–æ–µ (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ) + –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å —Ä–∞–∑–Ω–æ–π –∏–Ω—Ñ–æ–π
            let desc = '';
            let sentCount = 0;
            const maxLength = 400;
            
            for (let i = 0; i < uniqueSentences.length && sentCount < 4; i++) {
              const s = uniqueSentences[i];
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –ø—Ä–µ–≤—ã—Å–∏–º –ª–∏ –ª–∏–º–∏—Ç
              if ((desc + s).length > maxLength) {
                // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏ –æ–Ω–æ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ - –æ–±—Ä–µ–∑–∞–µ–º
                if (sentCount === 0 && s.length > 300) {
                  desc = s.slice(0, 297) + '...';
                  break;
                }
                // –ò–Ω–∞—á–µ –ø—Ä–µ–∫—Ä–∞—â–∞–µ–º –¥–æ–±–∞–≤–ª—è—Ç—å
                break;
              }
              
              desc += s + ' ';
              sentCount++;
              
              // –ú–∏–Ω–∏–º—É–º 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –Ω–æ –µ—Å–ª–∏ —É–∂–µ > 200 —Å–∏–º–≤–æ–ª–æ–≤ –∏ –µ—Å—Ç—å 2+ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è - –º–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
              if (sentCount >= 2 && desc.length >= 200 && desc.length <= 350) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –µ—â—ë –º–µ—Å—Ç–æ –¥–ª—è –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
                const nextSent = uniqueSentences[i + 1];
                if (nextSent && (desc + nextSent).length <= maxLength) {
                  continue; // –¥–æ–±–∞–≤–∏–º –µ—â—ë –æ–¥–Ω–æ
                } else {
                  break; // —Ö–≤–∞—Ç–∏—Ç
                }
              }
            }
            
            desc = desc.trim();
            
            // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –æ–±—Ä–µ–∑–∞–µ–º –µ—Å–ª–∏ –≤—ã—à–ª–æ –±–æ–ª—å—à–µ 400
            if (desc.length > 400) {
              desc = desc.slice(0, 397) + '...';
            }
            
            if (!desc) desc = cleaned.slice(0, 300);

            // –°—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Supabase ‚Äî –Ω–µ –∂–¥—ë–º –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏
            wikiBtn.textContent = 'üíæ';
            const pt = points[p.index];
            const { error } = await sb.from('markers').update({ desc: desc }).eq('id', pt.id);
            if (error) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –ø–∞–º—è—Ç–∏ –∏ –º–∞—Ä–∫–µ—Ä–µ
            pt.desc = desc;
            map.removeLayer(pt.marker);
            addMarker(pt, p.index);
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ —Ñ–æ—Ä–º–µ
            loadPointToForm(p.index);
            document.getElementById('pointDesc').value = desc;
            panel.scrollTop = 0;

          } catch(err) {
            alert('–û—à–∏–±–∫–∞ –í–∏–∫–∏: ' + err.message);
          }
          wikiBtn.disabled = false; wikiBtn.textContent = 'üìñ';
        };

        div.appendChild(rqBtn);
        div.appendChild(wikiBtn);
        div.appendChild(del);
        listDiv.appendChild(div);
      });
    }

    async function addOrEditPoint(lat, lng, name = '', desc = '') {
      try {
        if (editIndex >= 0) {
          const existing = points[editIndex];
          const { error } = await sb.from('markers').update({ lat, lng, name, desc }).eq('id', existing.id);
          if (error) {
            console.error('Supabase update error:', error);
            throw error;
          }
          
          map.removeLayer(existing.marker);
          existing.lat = lat;
          existing.lng = lng;
          existing.name = name;
          existing.desc = desc;
          addMarker(existing, editIndex);
          refreshList(searchInput.value.trim());
          clearForm();
        } else {
          const { data, error } = await sb.from('markers').insert([{ lat, lng, name, desc }]).select();
          if (error) {
            console.error('Supabase insert error:', error);
            alert(`–û—à–∏–±–∫–∞ Supabase: ${error.message}\n–ö–æ–¥: ${error.code}\n–î–µ—Ç–∞–ª–∏: ${error.details}`);
            throw error;
          }
          
          const newPoint = normalizePoint(data[0]);
          points.push(newPoint);
          addMarker(newPoint, points.length - 1);
          refreshList(searchInput.value.trim());
        }
      } catch (err) {
        console.error('Full error object:', err);
        if (!err.message?.includes('Supabase:')) {
          alert(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ—á–∫–∏: ${err.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
        }
      }
    }

    function flyToPoint(realIndex) {
      if (points.length === 0) return;
      // clamp with wrap
      if (realIndex < 0) realIndex = points.length - 1;
      if (realIndex >= points.length) realIndex = 0;

      const p = points[realIndex];
      if (!p) return;
      currentIndex = realIndex;
      map.flyTo([p.lat, p.lng], 14, { animate: true, duration: 1.5 });
      setTimeout(() => p.marker && p.marker.openPopup(), 900);
      refreshList(searchInput.value.trim());
    }

    // prevBtn/nextBtn handled in route mode section

    document.getElementById('migrateFromLocal').onclick = async () => {
      try {
        const localData = localStorage.getItem('savedPoints');
        if (!localData) return alert('–í localStorage –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫!');
        
        const oldPoints = JSON.parse(localData);
        if (!Array.isArray(oldPoints) || oldPoints.length === 0) {
          return alert('–í localStorage –Ω–µ—Ç —Ç–æ—á–µ–∫ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞!');
        }
        
        let count = 0;
        for (let p of oldPoints) {
          if (!isNaN(p.lat) && !isNaN(p.lng)) {
            const { error } = await sb.from('markers').insert([{ lat: Number(p.lat), lng: Number(p.lng) }]);
            if (!error) count++;
          }
        }
        
        alert(`–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ ${count} —Ç–æ—á–µ–∫ –≤ Supabase!`);
        await loadPoints();
      } catch (err) {
        console.error('Migration error:', err);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ —Ç–æ—á–µ–∫');
      }
    };

    addBtn.onclick = () => {
      const lat = parseFloat(document.getElementById('pointLat').value);
      const lng = parseFloat(document.getElementById('pointLng').value);
      const name = document.getElementById('pointName').value.trim();
      const desc = document.getElementById('pointDesc').value.trim();
      if (isNaN(lat) || isNaN(lng)) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã!");
      addOrEditPoint(lat, lng, name, desc);
    };

    document.getElementById('bulkWiki').onclick = async () => {
      const pwd = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏–π:');
      if (pwd !== '59872461') return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
      
      if (!confirm('–î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è –∏–∑ –í–∏–∫–∏–ø–µ–¥–∏–∏ –≤—Å–µ–º —Ç–æ—á–∫–∞–º —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏?\n\n–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.')) return;
      
      const pointsWithNames = points.filter(p => p.name && p.name.trim());
      if (pointsWithNames.length === 0) return alert('–ù–µ—Ç —Ç–æ—á–µ–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏!');
      
      let processed = 0;
      let success = 0;
      let failed = 0;
      
      for (const pt of pointsWithNames) {
        processed++;
        console.log(`[${processed}/${pointsWithNames.length}] –û–±—Ä–∞–±–æ—Ç–∫–∞: ${pt.name}`);
        
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ
        if (pt.desc && pt.desc.trim()) {
          console.log(`  ‚è≠ –£–∂–µ –µ—Å—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ`);
          continue;
        }
        
        try {
          const searches = [
            pt.name + ' —Å–µ–ª–æ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω',
            pt.name + ' –≥–æ—Ä–æ–¥ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω',
            pt.name + ' –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω',
            pt.name,
          ];

          let foundDesc = '';

          for (const query of searches) {
            const searchRes = await fetch(
              `https://ru.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*&srlimit=5`
            );
            const searchJson = await searchRes.json();
            const results = searchJson?.query?.search || [];

            for (const r of results) {
              const snippetLower = (r.snippet || '').toLowerCase();
              const isPerson =
                snippetLower.includes('—Ä–æ–¥–∏–ª—Å—è') ||
                snippetLower.includes('—Å–æ–≤–µ—Ç—Å–∫–∏–π') && snippetLower.includes('–∞–∫—Ç—ë—Ä') ||
                snippetLower.includes('–±–∏–æ–≥—Ä–∞—Ñ–∏—è') ||
                snippetLower.includes('–∫–∞–∑–∞—Ö—Å–∫–∏–π –ø–æ–ª–∏—Ç–∏–∫') ||
                snippetLower.includes('–¥–µ–ø—É—Ç–∞—Ç') ||
                /(–∞–∫—Ç—ë—Ä|–ø–µ–≤–µ—Ü|–ø–æ–ª–∏—Ç–∏–∫|—Å–ø–æ—Ä—Ç—Å–º–µ–Ω|—É—á—ë–Ω—ã–π|–ø–∏—Å–∞—Ç–µ–ª—å)/.test(snippetLower);
              if (isPerson) continue;

              const pageRes = await fetch(
                `https://ru.wikipedia.org/w/api.php?action=query&prop=extracts&exsectionformat=plain&explaintext=true&titles=${encodeURIComponent(r.title)}&format=json&origin=*`
              );
              if (!pageRes.ok) continue;
              const pageJson = await pageRes.json();
              const pages = pageJson?.query?.pages || {};
              const page = Object.values(pages)[0];
              const text = (page?.extract || '').trim();

              const textLower = text.toLowerCase();
              const isPlaceLike =
                textLower.includes('–Ω–∞—Å–µ–ª—ë–Ω–Ω—ã–π –ø—É–Ω–∫—Ç') ||
                textLower.includes('—Å–µ–ª–æ') ||
                textLower.includes('–≥–æ—Ä–æ–¥') ||
                textLower.includes('–∞—É–ª') ||
                textLower.includes('—Ä–∞–π–æ–Ω') ||
                textLower.includes('–ø–æ—Å—ë–ª–æ–∫') ||
                textLower.includes('–æ–±–ª–∞—Å—Ç—å') ||
                textLower.includes('—Ä–µ–∫–∞') ||
                textLower.includes('–æ–∑–µ—Ä–æ') ||
                textLower.includes('—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω');

              if (text && isPlaceLike) {
                foundDesc = text;
                break;
              }
            }

            if (foundDesc) break;
            await new Promise(resolve => setTimeout(resolve, 200));
          }

          if (foundDesc) {
            // –£–ú–ù–û–ï –°–ñ–ê–¢–ò–ï —Å —É–¥–∞–ª–µ–Ω–∏–µ–º –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∏ –≤—ã–±–æ—Ä–æ–º —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–π –∏–Ω—Ñ—ã
            let cleaned = foundDesc.split('\n').join(' ').replace(/[ \t]+/g, ' ').trim();
            cleaned = cleaned
              .replace(/[,.]?\s*–ö–æ–¥ –ö–ê–¢–û[^.]*\.?/gi, '')
              .replace(/[,.]?\s*–ö–ê–¢–û[^.]*\.?/gi, '')
              .replace(/[,.]?\s*–ø–æ—á—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å[^.]*\.?/gi, '')
              .replace(/[,.]?\s*—Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –∫–æ–¥[^.]*\.?/gi, '')
              .replace(/[,.]?\s*[\d]{6,}[^.]*\.?/gi, '')
              .replace(/\([^)]*–Ω–∞—Å–µ–ª–µ–Ω–∏–µ[^)]*\)/gi, '')
              .replace(/\([^)]*–≥–æ–¥[–∞–µ—É][^)]*\)/gi, '')
              .replace(/  +/g, ' ').trim();
            
            const sentences = cleaned.match(/[^.!?]+[.!?]+/g) || [cleaned];
            
            // –£–ë–ò–†–ê–ï–ú –î–£–ë–õ–ò–ö–ê–¢–´
            const uniqueSentences = [];
            const seen = new Set();
            for (const s of sentences) {
              const trimmed = s.trim();
              const normalized = trimmed.toLowerCase().replace(/\s+/g, ' ');
              if (!seen.has(normalized) && trimmed.length >= 30) {
                seen.add(normalized);
                uniqueSentences.push(trimmed);
              }
            }
            
            let shortDesc = '';
            let sentCount = 0;
            const maxLength = 400;
            
            for (let i = 0; i < uniqueSentences.length && sentCount < 4; i++) {
              const s = uniqueSentences[i];
              
              if ((shortDesc + s).length > maxLength) {
                if (sentCount === 0 && s.length > 300) {
                  shortDesc = s.slice(0, 297) + '...';
                  break;
                }
                break;
              }
              
              shortDesc += s + ' ';
              sentCount++;
              
              if (sentCount >= 2 && shortDesc.length >= 200 && shortDesc.length <= 350) {
                const nextSent = uniqueSentences[i + 1];
                if (nextSent && (shortDesc + nextSent).length <= maxLength) {
                  continue;
                } else {
                  break;
                }
              }
            }
            
            shortDesc = shortDesc.trim();
            
            if (shortDesc.length > 400) {
              shortDesc = shortDesc.slice(0, 397) + '...';
            }
            
            if (!shortDesc) shortDesc = cleaned.slice(0, 300);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤ Supabase
            const { error } = await sb.from('markers').update({ desc: shortDesc }).eq('id', pt.id);
            if (error) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –ø–∞–º—è—Ç–∏
            pt.desc = shortDesc;
            map.removeLayer(pt.marker);
            const idx = points.indexOf(pt);
            addMarker(pt, idx);
            
            success++;
            console.log(`  ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ (${shortDesc.length} —Å–∏–º–≤–æ–ª–æ–≤)`);
          } else {
            failed++;
            console.log(`  ‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ`);
          }
          
          await new Promise(resolve => setTimeout(resolve, 500));
          
        } catch (err) {
          failed++;
          console.error(`  ‚ùå –û—à–∏–±–∫–∞: ${err.message}`);
        }
      }
      
      refreshList();
      alert(`–ì–æ—Ç–æ–≤–æ!\n\n–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${processed}\n–£—Å–ø–µ—à–Ω–æ: ${success}\n–ù–µ –Ω–∞–π–¥–µ–Ω–æ: ${failed}`);
    };

    document.getElementById('deleteAll').onclick = async () => {
      const pwd = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–æ—á–µ–∫:');
      if (pwd !== '59872461') return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
      if (!confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç–æ—á–∫–∏?")) return;
      try {
        const { error } = await sb.from('markers').delete().neq('id', 0);
        if (error) throw error;
        points.forEach(p => p.marker && map.removeLayer(p.marker));
        points = [];
        refreshList();
      } catch (err) {
        console.error('Error deleting all points:', err);
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫');
      }
    };

    document.getElementById('saveJSON').onclick = () => {
      const data = JSON.stringify(points.map(p => ({ name: p.name, desc: p.desc, lat: p.lat, lng: p.lng })), null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = '–∫–∞—Ä—Ç–∞_ZKO.json'; a.click(); URL.revokeObjectURL(url);
    };

    document.getElementById('importJSON').onchange = async e => {
      const file = e.target.files[0];
      if (!file) return;
      if (prompt('–ü–∞—Ä–æ–ª—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞:') !== '59872461') { e.target.value = ''; return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!'); }
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (!Array.isArray(data)) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON!");
        
        let count = 0;
        for (let p of data) {
          if (!isNaN(p.lat) && !isNaN(p.lng)) {
            await addOrEditPoint(p.lat, p.lng, p.name || '', p.desc || '');
            count++;
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å Supabase
            await new Promise(resolve => setTimeout(resolve, 100));
          }
        }
        alert(`–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω! –î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–æ—á–µ–∫: ${count}`);
      } catch (err) {
        console.error('Import error:', err);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ JSON!");
      }
    };

    document.getElementById('importKml').onchange = async e => {
      const file = e.target.files[0];
      if (!file) return;
      if (prompt('–ü–∞—Ä–æ–ª—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞:') !== '59872461') { e.target.value = ''; return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!'); }
      
      try {
        let kmlText = '';
        
        // Check if it's KMZ (zip file) or plain KML
        if (file.name.endsWith('.kmz')) {
          // KMZ - extract KML from zip
          const zip = await JSZip.loadAsync(file);
          const kmlFile = Object.keys(zip.files).find(name => name.endsWith('.kml'));
          if (!kmlFile) return alert("–í KMZ –Ω–µ—Ç KML-—Ñ–∞–π–ª–∞!");
          kmlText = await zip.files[kmlFile].async('text');
        } else {
          // Plain KML - read directly
          kmlText = await file.text();
        }
        
        // Parse KML
        const xml = new DOMParser().parseFromString(kmlText, 'text/xml');
        const placemarks = xml.getElementsByTagName('Placemark');
        
        let count = 0;
        for (let p of placemarks) {
          const name = p.getElementsByTagName('name')[0]?.textContent || '';
          const desc = p.getElementsByTagName('description')[0]?.textContent || '';
          const coords = p.getElementsByTagName('coordinates')[0]?.textContent?.trim();
          if (!coords) continue;
          const [lng, lat] = coords.split(',').map(Number);
          if (isNaN(lat) || isNaN(lng)) continue;
          await addOrEditPoint(lat, lng, name, desc);
          count++;
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        alert(`–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω! –î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–æ—á–µ–∫: ${count}`);
      } catch (err) {
        console.error('KML/KMZ import error:', err);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ KML/KMZ —Ñ–∞–π–ª–∞!");
      }
    };

    document.getElementById('selectModeBtn').onclick = () => {
      selectMode = !selectMode;
      document.getElementById('selectModeBtn').textContent = selectMode ? '–û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä' : '–í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ';
      map.getContainer().style.cursor = selectMode ? 'crosshair' : '';
    };

    map.on('click', e => {
      if (selectMode) {
        document.getElementById('pointLat').value = e.latlng.lat.toFixed(6);
        document.getElementById('pointLng').value = e.latlng.lng.toFixed(6);
        selectMode = false;
        document.getElementById('selectModeBtn').textContent = '–í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ';
        map.getContainer().style.cursor = '';
      }
    });

    searchInput.oninput = e => refreshList(e.target.value.trim());


    // ‚îÄ‚îÄ ROUTE MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let routeOrder = []; // array of point indices defining navigation order
    let routePos = 0;    // current position in routeOrder
    let routeMode = false;

    const routeBtn = document.getElementById('routeBtn');
    const routePanel = document.getElementById('routePanel');
    const mainPanel = document.getElementById('mainPanel');

    routeBtn.onclick = () => {
      routeMode = !routeMode;
      routeBtn.classList.toggle('active', routeMode);
      routeBtn.textContent = routeMode ? '‚úï –ó–∞–∫—Ä—ã—Ç—å –º–∞—Ä—à—Ä—É—Ç' : 'üó∫ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç ‚Üê‚Üí';
      routePanel.classList.toggle('active', routeMode);
      mainPanel.classList.toggle('route-hidden', routeMode);
      if (routeMode) renderRoutePanel();
    };

    document.getElementById('routeClearBtn').onclick = () => {
      routeOrder = []; routePos = 0; renderRoutePanel();
    };

    document.getElementById('routeSearch').oninput = e => renderRouteAddList(e.target.value.trim());

    function renderRoutePanel() {
      renderRouteList();
      renderRouteAddList(document.getElementById('routeSearch').value.trim());
    }

    let routeDragSrc = null;

    function renderRouteList() {
      const el = document.getElementById('routeList');
      el.innerHTML = '';
      if (routeOrder.length === 0) {
        el.innerHTML = '<p style="font-size:12px;color:#888;text-align:center;">–ú–∞—Ä—à—Ä—É—Ç –ø—É—Å—Ç</p>';
        return;
      }
      routeOrder.forEach((pi, ri) => {
        const p = points[pi];
        if (!p) return;
        const div = document.createElement('div');
        div.className = 'route-item';
        div.draggable = true;
        div.innerHTML = `<span class="route-num">${ri+1}</span>
          <div class="point-text" style="flex:1;min-width:0;margin:0 4px;">${p.name ? `<b>${p.name}</b>` : `<b>–¢–æ—á–∫–∞ ${pi+1}</b>`}<br><small>${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}</small></div>
          <button class="route-del" title="–£–±—Ä–∞—Ç—å –∏–∑ –º–∞—Ä—à—Ä—É—Ç–∞">‚úï</button>`;

        div.querySelector('.route-del').onclick = () => {
          routeOrder.splice(ri, 1);
          if (routePos >= routeOrder.length) routePos = Math.max(0, routeOrder.length - 1);
          renderRouteList();
        };

        div.addEventListener('dragstart', e => { routeDragSrc = ri; setTimeout(() => div.classList.add('dragging'), 0); });
        div.addEventListener('dragend', () => div.classList.remove('dragging'));
        div.addEventListener('dragover', e => { e.preventDefault(); div.classList.add('drag-over'); });
        div.addEventListener('dragleave', () => div.classList.remove('drag-over'));
        div.addEventListener('drop', e => {
          e.preventDefault(); div.classList.remove('drag-over');
          if (routeDragSrc === null || routeDragSrc === ri) return;
          const moved = routeOrder.splice(routeDragSrc, 1)[0];
          routeOrder.splice(ri, 0, moved);
          routeDragSrc = null;
          renderRouteList();
        });

        el.appendChild(div);
      });
    }

    function renderRouteAddList(filter = '') {
      const el = document.getElementById('routeAddList');
      el.innerHTML = '';
      const lf = filter.toLowerCase();
      points.forEach((p, i) => {
        if (routeOrder.includes(i)) return; // already in route
        const name = p.name || `–¢–æ—á–∫–∞ ${i+1}`;
        if (lf && !name.toLowerCase().includes(lf) && !`${p.lat.toFixed(4)},${p.lng.toFixed(4)}`.includes(lf)) return;
        const div = document.createElement('div');
        div.className = 'route-item';
        div.style.cursor = 'pointer';
        div.innerHTML = `<span style="font-size:16px;flex-shrink:0">Ôºã</span>
          <div class="point-text" style="flex:1;min-width:0;margin-left:4px;">${p.name ? `<b>${p.name}</b>` : `<b>–¢–æ—á–∫–∞ ${i+1}</b>`}<br><small>${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}</small></div>`;
        div.onclick = () => { routeOrder.push(i); renderRoutePanel(); };
        el.appendChild(div);
      });
      if (el.innerHTML === '') el.innerHTML = '<p style="font-size:12px;color:#888;text-align:center;">–í—Å–µ —Ç–æ—á–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>';
    }

    // Override prev/next to use routeOrder when active
    document.getElementById('prevBtn').onclick = () => {
      if (routeMode && routeOrder.length > 0) {
        routePos = routePos <= 0 ? routeOrder.length - 1 : routePos - 1;
        flyToPoint(routeOrder[routePos]);
      } else {
        if (points.length === 0) return;
        const newIdx = currentIndex <= 0 ? points.length - 1 : currentIndex - 1;
        flyToPoint(newIdx);
      }
    };
    document.getElementById('nextBtn').onclick = () => {
      if (routeMode && routeOrder.length > 0) {
        routePos = routePos >= routeOrder.length - 1 ? 0 : routePos + 1;
        flyToPoint(routeOrder[routePos]);
      } else {
        if (points.length === 0) return;
        const newIdx = currentIndex >= points.length - 1 ? 0 : currentIndex + 1;
        flyToPoint(newIdx);
      }
    };
    // ‚îÄ‚îÄ END ROUTE MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


    // ‚îÄ‚îÄ Online presence ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // ‚îÄ‚îÄ –ê–í–¢–û–ì–ï–ù–ï–†–ê–¶–ò–Ø –¢–û–ß–ï–ö –ö–ê–ó–ê–•–°–¢–ê–ù–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const kazakhstanPlaces = {
      zko: [
        // –ì–æ—Ä–æ–¥–∞
        {name:'–£—Ä–∞–ª—å—Å–∫',lat:51.2167,lng:51.3667},{name:'–ê–∫—Å–∞–π',lat:51.1667,lng:52.9667},{name:'–ñ–∞–Ω–∏–±–µ–∫',lat:49.3833,lng:46.8833},
        // –°–µ–ª–∞ –ë–æ–∫–µ–π–æ—Ä–¥–∏–Ω—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞
        {name:'–°–∞–π—Ö–∏–Ω',lat:49.83,lng:48.49},{name:'–ß–∞–ø–∞–µ–≤–æ',lat:49.77,lng:48.15},{name:'–ñ–∞–ª–ø–∞–∫—Ç–∞–ª',lat:49.65,lng:48.80},
        {name:'–ö–∞—Ä–∞–æ–∑–µ–∫',lat:49.91,lng:47.99},{name:'–¢–∞—Å–∫–∞–ª–∞',lat:49.72,lng:48.92},{name:'–§–µ–¥–æ—Ä–æ–≤–∫–∞',lat:50.83,lng:50.68},
        // –°–µ–ª–∞ –ë—É—Ä–ª–∏–Ω—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞
        {name:'–ë—É—Ä–ª–∏–Ω',lat:51.48,lng:54.05},{name:'–ê–∫—Å—É–∞—Ç',lat:51.55,lng:53.87},{name:'–ë–∏—Å–º—É—Ä—É–Ω',lat:51.42,lng:54.21},
        {name:'–ñ–∞—Ä—Å—É–∞—Ç',lat:51.48,lng:53.29},{name:'–ö–∞—Ä–∞—Ç—é–±–µ',lat:51.39,lng:54.17},
        // –°–µ–ª–∞ –ñ–∞–Ω–≥–∞–ª–∏–Ω—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞
        {name:'–ñ–∞–Ω–≥–∞–ª–∞',lat:49.17,lng:50.63},{name:'–®—É–±–∞—Ä—à–∏',lat:49.05,lng:50.89},{name:'–ö—É—Ä–∞–π–ª—ã',lat:49.23,lng:50.47},
        {name:'–ö–∞—Ä—à—ã–≥–∞',lat:49.31,lng:50.55},{name:'–ö–∞—Ä–∞–æ–±–µ',lat:49.09,lng:51.02},
        // –°–µ–ª–∞ –ñ–∞–Ω–∏–±–µ–∫—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞  
        {name:'–î–∞—Ä—å–∏–Ω—Å–∫',lat:49.27,lng:47.18},{name:'–ö–∑—ã–ª–∫–æ–≥–∞',lat:49.45,lng:46.95},{name:'–ü–µ—Ä–µ–º–µ—Ç–Ω–æ–µ',lat:50.68,lng:51.13},
        {name:'–¢–∞–ª–æ–≤–∫–∞',lat:49.52,lng:47.12},{name:'–ú–∞–º–∞–π',lat:49.38,lng:47.33},
        // –°–µ–ª–∞ –ó–µ–ª–µ–Ω–æ–≤—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞
        {name:'–ó–µ–ª–µ–Ω–æ–≤–∫–∞',lat:51.25,lng:52.18},{name:'–ó–µ–ª–µ–Ω–æ–µ',lat:51.31,lng:52.05},{name:'–§–µ–¥–æ—Ä–æ–≤–∫–∞',lat:51.17,lng:52.33},
        {name:'–ß–∞–≥–∞–Ω–∫–∞',lat:51.22,lng:52.42},{name:'–î–º–∏—Ç—Ä–∏–µ–≤–∫–∞',lat:51.28,lng:52.27},
        // –°–µ–ª–∞ –ö–∞–∑—Ç–∞–ª–æ–≤—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞
        {name:'–ö–∞–∑—Ç–∞–ª–æ–≤–∫–∞',lat:50.65,lng:50.58},{name:'–î–æ–Ω—Å–∫–æ–µ',lat:50.72,lng:50.47},{name:'–ë–æ–ª—å—à–µ–≤–∏–∫',lat:50.58,lng:50.71},
        {name:'–ñ–∞–Ω–∞—Ç–∞–Ω',lat:50.61,lng:50.52},{name:'–ö–∞—Ä–∞–∞–≥–∞—à',lat:50.68,lng:50.63},
        // –°–µ–ª–∞ –ö–∞—Ä–∞—Ç–æ–±–∏–Ω—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞
        {name:'–ö–∞—Ä–∞—Ç–æ–±–µ',lat:51.07,lng:51.83},{name:'–ê–∫–∂–∞—Ä',lat:51.15,lng:51.72},{name:'–°–∞—Ä—ã–∫–∞–º—ã—Å',lat:51.02,lng:51.95},
        {name:'–ê–∫–±—É–ª–∞–∫',lat:50.98,lng:51.78},{name:'–ö–∞—Ä–∞—Å—É',lat:51.11,lng:51.88},
        // –°–µ–ª–∞ –°—ã—Ä—ã–º—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞
        {name:'–ñ—ã–º–ø–∏—Ç—ã',lat:50.65,lng:52.35},{name:'–°–∞—Ä—ã–∫–æ–ª—å',lat:50.72,lng:52.48},{name:'–ö–∞—Ä–∞—Å—É',lat:50.58,lng:52.21},
        {name:'–ê–∫–∂–∞–π—ã–∫',lat:50.63,lng:52.52},{name:'–ö–æ–∫—Ç–æ–±–µ',lat:50.69,lng:52.39},
        // –°–µ–ª–∞ –¢–∞—Å–∫–∞–ª–∏–Ω—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞
        {name:'–¢–∞—Å–∫–∞–ª–∞',lat:49.73,lng:49.28},{name:'–ñ–∞–Ω–∞—Ç–∞–ª–∞–ø',lat:49.65,lng:49.42},{name:'–ö–æ–∫—Ç–∞–ª',lat:49.81,lng:49.15},
        {name:'–ö–æ–∫–∞—Ä–∞–ª',lat:49.77,lng:49.33},{name:'–ö—ã–∑—ã–ª—Ç–∞–ª',lat:49.69,lng:49.51},
        // –°–µ–ª–∞ –¢–µ—Ä–µ–∫—Ç–∏–Ω—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞
        {name:'–¢–µ—Ä–µ–∫—Ç—ã',lat:50.38,lng:52.72},{name:'–ö–∞–π–Ω–∞—Ä',lat:50.45,lng:52.65},{name:'–ñ–∞–Ω–∞-–ö–∞–π–Ω–∞—Ä',lat:50.32,lng:52.83},
        {name:'–ñ–∞–Ω–∞–∫–æ–Ω—ã—Å',lat:50.41,lng:52.77},{name:'–ö–∞—Ä–∞–∞–≥–∞—à',lat:50.35,lng:52.69},
        // –°–µ–ª–∞ –ß–∏–Ω–≥–∏—Ä–ª–∞—É—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞
        {name:'–ß–∏–Ω–≥–∏—Ä–ª–∞—É',lat:51.58,lng:50.55},{name:'–ö–∞—Ä–∞—É–∑–µ–∫',lat:51.65,lng:50.42},{name:'–°–∞—Ä—ã',lat:51.52,lng:50.68},
        {name:'–ñ–∞–º–±–∞–π',lat:51.61,lng:50.51},{name:'–ö–∞–º–µ–Ω–∫–∞',lat:51.03,lng:51.07},
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–µ–ª–∞
        {name:'–ß–∞–ø–∞–µ–≤',lat:50.17,lng:51.18},{name:'–ñ–µ—Ç—ã–∫–æ–ª—å',lat:49.89,lng:52.59},{name:'–ö–∞—Ä–∞–∂–∞—Ä',lat:50.92,lng:51.45},
        {name:'–ö–æ–∫—Ç–∞–ª',lat:50.55,lng:51.78},{name:'–°–∞—Ä—ã–∫–æ–ø–∞',lat:51.12,lng:52.33},{name:'–ö–∞–π—Ä–∞–∫',lat:50.28,lng:51.92}
      ],
      aktobe: [
        {name:'–ê–∫—Ç–æ–±–µ',lat:50.2961,lng:57.1672},{name:'–•—Ä–æ–º—Ç–∞—É',lat:50.2547,lng:58.4361},{name:'–ê–ª–≥–∞',lat:50.1833,lng:57.3333},
        {name:'–ö–æ–±–¥–∞',lat:48.91,lng:59.66},{name:'–ú–∞—Ä—Ç—É–∫',lat:49.75,lng:58.83},{name:'–¢–µ–º–∏—Ä',lat:49.14,lng:57.14},
        {name:'–≠–º–±–∞',lat:48.83,lng:58.15},{name:'–ö–∞–Ω–¥—ã–∞–≥–∞—à',lat:49.47,lng:57.42},{name:'–®—É–±–∞—Ä–∫—É–¥—É–∫',lat:49.15,lng:59.38},
        {name:'–ò—Ä–≥–∏–∑',lat:48.63,lng:61.28},{name:'–ë–∞–π–≥–∞–Ω–∏–Ω',lat:48.68,lng:55.87},{name:'–ú—É–≥–∞–ª–∂–∞—Ä',lat:49.65,lng:58.52},
        {name:'–ö–∞—Ä–∞–±—É—Ç–∞–∫',lat:49.95,lng:58.17},{name:'–ñ–µ—Ç—ã–∫–∞—Ä–∞',lat:49.28,lng:57.87},{name:'–ö–∞—Ä–≥–∞–ª—ã',lat:50.12,lng:57.58}
      ],
      atyrau: [
        {name:'–ê—Ç—ã—Ä–∞—É',lat:47.1167,lng:51.8833},{name:'–ö—É–ª—å—Å–∞—Ä—ã',lat:46.9667,lng:54.0167},{name:'–ú–∞–∫–∞—Ç',lat:47.6500,lng:53.3167},
        {name:'–ò–Ω–¥–µ—Ä–±–æ—Ä—Å–∫–∏–π',lat:48.5667,lng:51.9000},{name:'–ñ—ã–ª—ã–æ–π',lat:47.1667,lng:54.6167},{name:'–î–æ—Å—Å–æ—Ä',lat:46.6833,lng:53.0167},
        {name:'–ë–∞–ª—ã–∫—à–∏',lat:47.07,lng:51.85},{name:'–ú–∏—è–ª—ã',lat:47.25,lng:52.15},{name:'–ö—É—Ä–º–∞–Ω–≥–∞–∑—ã',lat:46.77,lng:52.08},
        {name:'–ú–∞—Ö–∞–º–±–µ—Ç',lat:47.65,lng:52.95},{name:'–ö—ã–∑—ã–ª–∫–æ–≥–∞',lat:47.42,lng:52.48},{name:'–ì–∞–Ω—é—à–∫–∏–Ω–æ',lat:47.33,lng:52.72}
      ],
      mangystau: [
        {name:'–ê–∫—Ç–∞—É',lat:43.6500,lng:51.2000},{name:'–ñ–∞–Ω–∞–æ–∑–µ–Ω',lat:43.3333,lng:52.8667},{name:'–ë–µ–π–Ω–µ—É',lat:45.3167,lng:55.2000},
        {name:'–§–æ—Ä—Ç-–®–µ–≤—á–µ–Ω–∫–æ',lat:44.5167,lng:50.2667},{name:'–°–∞–π-–£—Ç–µ—Å',lat:43.1833,lng:52.3500},{name:'–®–µ—Ç–ø–µ',lat:44.17,lng:52.12},
        {name:'–ö–∞—Ä–∞–∫–∏—è',lat:43.83,lng:51.73},{name:'–¢—é–ø–∫–∞—Ä–∞–≥–∞–Ω',lat:43.55,lng:52.65},{name:'–ë–∞—É—Ç–∏–Ω–æ',lat:44.73,lng:50.13},
        {name:'–ö—É—Ä—ã–∫',lat:43.18,lng:52.47},{name:'–ö–∞–ª–∞–º–∫–∞—Å',lat:43.92,lng:51.45},{name:'–ê–∫—Ç–∞—É-3',lat:43.62,lng:51.17}
      ],
      karaganda: [
        {name:'–ö–∞—Ä–∞–≥–∞–Ω–¥–∞',lat:49.8047,lng:73.1094},{name:'–¢–µ–º–∏—Ä—Ç–∞—É',lat:50.0667,lng:72.9667},{name:'–ë–∞–ª—Ö–∞—à',lat:46.8500,lng:75.0000},
        {name:'–°–∞—Ç–ø–∞–µ–≤',lat:47.9167,lng:66.9167},{name:'–ñ–µ–∑–∫–∞–∑–≥–∞–Ω',lat:47.7833,lng:67.7167},{name:'–ö–∞—Ä–∞–∂–∞–ª',lat:48.0167,lng:70.0167},
        {name:'–ü—Ä–∏–æ–∑–µ—Ä—Å–∫',lat:46.75,lng:74.98},{name:'–ê–±–∞–π',lat:49.63,lng:72.85},{name:'–°–∞—Ä–∞–Ω—å',lat:49.87,lng:73.12},
        {name:'–®–∞—Ö—Ç–∏–Ω—Å–∫',lat:49.72,lng:72.58},{name:'–ö–∞—Ä–∫–∞—Ä–∞–ª–∏–Ω—Å–∫',lat:49.42,lng:75.48},{name:'–ñ–∞–Ω–∞–∞—Ä–∫–∞',lat:47.35,lng:70.22},
        {name:'–£–ª—ã—Ç–∞—É',lat:48.25,lng:67.03},{name:'–ê–∫—Ç–æ–≥–∞–π',lat:47.78,lng:67.28},{name:'–ê–≥–∞–¥—ã—Ä—å',lat:47.52,lng:71.68}
      ],
      kostanay: [
        {name:'–ö–æ—Å—Ç–∞–Ω–∞–π',lat:53.2139,lng:63.6247},{name:'–†—É–¥–Ω—ã–π',lat:52.9667,lng:63.1167},{name:'–ê—Ä–∫–∞–ª—ã–∫',lat:50.2486,lng:66.9117},
        {name:'–õ–∏—Å–∞–∫–æ–≤—Å–∫',lat:52.5333,lng:62.5000},{name:'–ñ–∏—Ç–∏–∫–∞—Ä–∞',lat:52.1833,lng:61.2000},{name:'–£–∑—É–Ω–∫–æ–ª—å',lat:52.27,lng:62.48},
        {name:'–¢–∞—Ä–∞–Ω–æ–≤—Å–∫–æ–µ',lat:53.75,lng:64.93},{name:'–§–µ–¥–æ—Ä–æ–≤–∫–∞',lat:52.42,lng:65.38},{name:'–ê–º–∞–Ω–∫–∞—Ä–∞–≥–∞–π',lat:51.12,lng:62.83},
        {name:'–ê—É–ª–∏–µ–∫–æ–ª—å',lat:51.68,lng:64.22},{name:'–î–∂–∞–Ω–≥–∏–ª—å–¥–∏–Ω',lat:51.57,lng:62.32},{name:'–ö–∞—Ä–∞–±–∞–ª—ã–∫',lat:53.73,lng:62.18},
        {name:'–ö–∞—Ä–∞—Å—É',lat:53.05,lng:65.75},{name:'–ö–∞–º—ã—Å—Ç—ã',lat:52.78,lng:64.28},{name:'–ó–∞—Ç–æ–±–æ–ª—å—Å–∫',lat:52.48,lng:61.18}
      ],
      pavlodar: [
        {name:'–ü–∞–≤–ª–æ–¥–∞—Ä',lat:52.2869,lng:76.9461},{name:'–≠–∫–∏–±–∞—Å—Ç—É–∑',lat:51.7236,lng:75.3222},{name:'–ê–∫—Å—É',lat:52.0400,lng:76.9300},
        {name:'–ö–∞—á–∏—Ä—ã',lat:51.9333,lng:78.1167},{name:'–ë–∞—è–Ω–∞—É–ª',lat:50.80,lng:75.72},{name:'–ñ–µ–ª–µ–∑–∏–Ω–∫–∞',lat:52.48,lng:77.85},
        {name:'–£—Å–ø–µ–Ω–∫–∞',lat:52.77,lng:77.28},{name:'–®–∞—Ä–±–∞–∫—Ç—ã',lat:51.42,lng:77.55},{name:'–ú–∞–π–∫–∞–∏–Ω',lat:51.37,lng:73.55},
        {name:'–ò—Ä—Ç—ã—à—Å–∫',lat:53.35,lng:76.42},{name:'–õ–µ–±—è–∂—å–µ',lat:52.52,lng:75.28},{name:'–ê–∫—Ç–æ–≥–∞–π',lat:51.17,lng:76.32}
      ],
      sko: [
        {name:'–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫',lat:54.8667,lng:69.1500},{name:'–ë—É–ª–∞–µ–≤–æ',lat:54.9000,lng:70.4333},{name:'–¢–∞–π—ã–Ω—à–∞',lat:53.8667,lng:69.7167},
        {name:'–ú–∞–º–ª—é—Ç–∫–∞',lat:55.0667,lng:67.7500},{name:'–ü—Ä–µ—Å–Ω–æ–≤–∫–∞',lat:54.77,lng:69.57},{name:'–Ø–≤–ª–µ–Ω–∫–∞',lat:54.23,lng:70.77},
        {name:'–°–º–∏—Ä–Ω–æ–≤–æ',lat:54.58,lng:69.93},{name:'–ö—ã–∑—ã–ª—Ç—É',lat:54.12,lng:68.48},{name:'–ê–∫–∫–∞–π—ã–Ω—Å–∫–∏–π',lat:54.97,lng:68.32},
        {name:'–¢–∏–º–∏—Ä—è–∑–µ–≤–æ',lat:54.63,lng:69.18},{name:'–ê–π—ã—Ä—Ç–∞—É',lat:53.23,lng:70.28},{name:'–ë–∏—à–∫—É–ª—å',lat:53.97,lng:69.35}
      ],
      vko: [
        {name:'–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫',lat:49.9481,lng:82.6281},{name:'–°–µ–º–µ–π',lat:50.4111,lng:80.2275},{name:'–†–∏–¥–¥–µ—Ä',lat:50.3450,lng:83.5100},
        {name:'–ó—ã—Ä—è–Ω–æ–≤—Å–∫',lat:49.7333,lng:84.2667},{name:'–®–µ–º–æ–Ω–∞–∏—Ö–∞',lat:50.6333,lng:81.9000},{name:'–ö—É—Ä—á–∞—Ç–æ–≤',lat:50.7667,lng:78.5833},
        {name:'–°–µ—Ä–µ–±—Ä—è–Ω—Å–∫',lat:49.67,lng:83.45},{name:'–ì–ª—É–±–æ–∫–æ–µ',lat:49.93,lng:82.32},{name:'–ë–æ–ª—å—à–µ–Ω–∞—Ä—ã–º—Å–∫–æ–µ',lat:49.22,lng:82.73},
        {name:'–£–ª–∞–Ω—Å–∫–∏–π',lat:50.12,lng:81.35},{name:'–ê—è–≥–æ–∑',lat:47.97,lng:80.42},{name:'–ñ–∞—Ä–º–∞',lat:47.53,lng:80.03},
        {name:'–®–∞—Ä',lat:50.57,lng:81.07},{name:'–ó–∞—â–∏—Ç–∞',lat:50.25,lng:82.88},{name:'–£—Ä–¥–∂–∞—Ä',lat:47.10,lng:81.63}
      ],
      almaty: [
        {name:'–¢–∞–ª–¥—ã–∫–æ—Ä–≥–∞–Ω',lat:45.0150,lng:78.3739},{name:'–ö–∞–ø—à–∞–≥–∞–π',lat:43.8833,lng:77.0833},{name:'–¢–∞–ª–≥–∞—Ä',lat:43.3000,lng:77.2333},
        {name:'–ï—Å–∏–∫',lat:43.3500,lng:77.4500},{name:'–ñ–∞—Ä–∫–µ–Ω—Ç',lat:44.1667,lng:80.0000},{name:'–¢–µ–∫–µ–ª–∏',lat:45.25,lng:79.87},
        {name:'–ö–∞—Å–∫–µ–ª–µ–Ω',lat:43.20,lng:76.63},{name:'–°–∞—Ä–∫–∞–Ω–¥',lat:45.42,lng:79.92},{name:'–ü–∞–Ω—Ñ–∏–ª–æ–≤',lat:43.35,lng:79.97},
        {name:'–£—à–∞—Ä–∞–ª',lat:46.18,lng:81.53},{name:'–£—à—Ç–æ–±–µ',lat:45.25,lng:77.98},{name:'–ö–∞—Ä–∞–±—É–ª–∞–∫',lat:43.77,lng:77.55},
        {name:'–û—Ç–µ–≥–µ–Ω-–ë–∞—Ç—ã—Ä',lat:43.53,lng:76.97},{name:'–ê–ª–≥–∞–±–∞—Å',lat:44.73,lng:78.52},{name:'–ö–æ–∫–ø–µ–∫—Ç—ã',lat:46.67,lng:82.12}
      ],
      zhambyl: [
        {name:'–¢–∞—Ä–∞–∑',lat:42.9000,lng:71.3667},{name:'–®—É',lat:43.5981,lng:73.7578},{name:'–ö–∞—Ä–∞—Ç–∞—É',lat:43.1833,lng:70.4667},
        {name:'–ú–µ—Ä–∫–µ',lat:42.9000,lng:73.1833},{name:'–õ—É–≥–æ–≤–æ–µ',lat:43.38,lng:73.45},{name:'–ñ–∞–º–±—ã–ª',lat:43.32,lng:71.12},
        {name:'–ê—Å–∞',lat:43.38,lng:71.75},{name:'–ö–æ—Ä–¥–∞–π',lat:43.28,lng:75.25},{name:'–¢–∞—Å—Å–∞–π',lat:42.52,lng:72.23},
        {name:'–°–∞—Ä—ã—Å—É',lat:44.72,lng:73.58},{name:'–ë–æ–≥–µ—Ç—Å–∞–π',lat:42.67,lng:71.77},{name:'–ú–æ–π—ã–Ω–∫—É–º',lat:43.97,lng:73.97}
      ],
      turkestan: [
        {name:'–¢—É—Ä–∫–µ—Å—Ç–∞–Ω',lat:43.3000,lng:68.2500},{name:'–®—ã–º–∫–µ–Ω—Ç',lat:42.3167,lng:69.5964},{name:'–ö–µ–Ω—Ç–∞—É',lat:43.5167,lng:68.5000},
        {name:'–ê—Ä—ã—Å—å',lat:42.4333,lng:68.8000},{name:'–°–∞—Ä—ã–∞–≥–∞—à',lat:41.4500,lng:69.1667},{name:'–õ–µ–Ω–≥–µ—Ä',lat:42.18,lng:69.88},
        {name:'–ñ–µ—Ç—ã—Å–∞–π',lat:41.27,lng:69.80},{name:'–ö–∞–∑—ã–≥—É—Ä—Ç',lat:41.68,lng:69.40},{name:'–®–∞—Ä–¥–∞—Ä–∞',lat:41.25,lng:67.97},
        {name:'–û—Ç—ã—Ä–∞—Ä',lat:42.58,lng:68.30},{name:'–¢—É—Ä–∫–µ—Å—Ç–∞–Ω',lat:43.30,lng:68.25},{name:'–ö–µ–ª–µ—Å',lat:42.17,lng:70.88},
        {name:'–ú–∞—Ö—Ç–∞–∞—Ä–∞–ª',lat:41.73,lng:68.72},{name:'–û—Ä–¥–∞–±–∞—Å—ã',lat:42.62,lng:69.68},{name:'–¢“Ø–ª–∫—ñ–±–∞—Å',lat:42.45,lng:70.03}
      ],
      kyzylorda: [
        {name:'–ö—ã–∑—ã–ª–æ—Ä–¥–∞',lat:44.8528,lng:65.5094},{name:'–ë–∞–π–∫–æ–Ω—ã—Ä',lat:45.6167,lng:63.3167},{name:'–ê—Ä–∞–ª—å—Å–∫',lat:46.7833,lng:61.6667},
        {name:'–®–∏–µ–ª–∏',lat:44.1667,lng:66.7333},{name:'–ñ–∞–ª–∞–≥–∞—à',lat:44.75,lng:66.82},{name:'–ö–∞–∑–∞–ª–∏–Ω—Å–∫',lat:45.77,lng:62.10},
        {name:'–ñ–æ—Å–∞–ª—ã',lat:45.48,lng:64.08},{name:'–¢–µ—Ä–µ–Ω–æ–∑–µ–∫',lat:44.05,lng:65.73},{name:'–ê–∫—Å—É–∫–µ–Ω—Ç',lat:44.52,lng:65.92},
        {name:'–ê–π—Ç–µ–∫–µ-–ë–∏',lat:45.23,lng:66.87},{name:'–ñ–∞–Ω–∞–∫–æ—Ä–≥–∞–Ω',lat:43.87,lng:67.38},{name:'–°—ã—Ä–¥–∞—Ä—å—è',lat:44.80,lng:67.47}
      ],
      akmola: [
        {name:'–ö–æ–∫—à–µ—Ç–∞—É',lat:53.2858,lng:69.3917},{name:'–°—Ç–µ–ø–Ω–æ–≥–æ—Ä—Å–∫',lat:52.3500,lng:71.8833},{name:'–©—É—á–∏–Ω—Å–∫',lat:52.9333,lng:70.1833},
        {name:'–ú–∞–∫–∏–Ω—Å–∫',lat:52.6333,lng:70.4167},{name:'–ê—Ç–±–∞—Å–∞—Ä',lat:51.8167,lng:68.3500},{name:'–ï—Ä–µ–π–º–µ–Ω—Ç–∞—É',lat:51.62,lng:73.10},
        {name:'–ë–∞–ª–∫–∞—à–∏–Ω–æ',lat:52.82,lng:70.87},{name:'–ê–∫–∫–æ–ª—å',lat:52.53,lng:70.77},{name:'–ï—Å–∏–ª—å',lat:51.95,lng:66.40},
        {name:'–î–µ—Ä–∂–∞–≤–∏–Ω—Å–∫',lat:51.08,lng:66.32},{name:'–ñ–∞—Ä–∫–∞–∏–Ω',lat:52.87,lng:71.58},{name:'–°—Ç–µ–ø–Ω—è–∫',lat:52.35,lng:71.73},
        {name:'–ê—Ä—à–∞–ª—ã',lat:51.35,lng:69.88},{name:'–®–æ—Ä—Ç–∞–Ω–¥—ã',lat:52.12,lng:70.72},{name:'–ó–µ—Ä–µ–Ω–¥–∏–Ω—Å–∫–æ–µ',lat:53.07,lng:69.82}
      ]
    };

    document.getElementById('autoGenBtn').onclick = () => {
      document.getElementById('autoGenModal').style.display = 'flex';
    };

    document.getElementById('autoGenCancel').onclick = () => {
      document.getElementById('autoGenModal').style.display = 'none';
    };

    // Checkbox toggle for "add all"
    document.getElementById('autoGenAll').onchange = e => {
      document.getElementById('countWrap').style.opacity = e.target.checked ? '0.5' : '1';
      document.getElementById('autoGenCount').disabled = e.target.checked;
    };

    document.getElementById('autoGenStart').onclick = async () => {
      const addAll = document.getElementById('autoGenAll').checked;
      const count = parseInt(document.getElementById('autoGenCount').value);
      const region = document.getElementById('autoGenRegion').value;
      
      if (!addAll && (isNaN(count) || count < 1)) {
        return alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ"');
      }

      const pwd = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:');
      if (pwd !== '59872461') return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');

      // –°–æ–±–∏—Ä–∞–µ–º —Ç–æ—á–∫–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
      let places = [];
      if (region === 'all') {
        Object.values(kazakhstanPlaces).forEach(arr => places.push(...arr));
      } else {
        places = kazakhstanPlaces[region] || [];
      }

      if (places.length === 0) return alert('–ù–µ—Ç —Ç–æ—á–µ–∫ –¥–ª—è —ç—Ç–æ–π –æ–±–ª–∞—Å—Ç–∏');

      // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –∏ –±–µ—Ä–µ–º –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–∏–ª–∏ –≤—Å–µ)
      places = places.sort(() => Math.random() - 0.5);
      if (!addAll) {
        places = places.slice(0, Math.min(count, places.length));
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
      document.getElementById('autoGenProgress').style.display = 'block';
      document.getElementById('autoGenTotal').textContent = places.length;
      document.getElementById('autoGenStart').disabled = true;

      let added = 0;
      let skipped = 0;

      for (let i = 0; i < places.length; i++) {
        const place = places[i];
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        document.getElementById('autoGenCurrent').textContent = i + 1;
        document.getElementById('autoGenBar').style.width = `${((i + 1) / places.length) * 100}%`;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
        const exists = points.some(p => 
          Math.abs(p.lat - place.lat) < 0.01 && 
          Math.abs(p.lng - place.lng) < 0.01
        );

        if (exists) {
          console.log(`‚è≠ –ü—Ä–æ–ø—É—Å–∫–∞–µ–º ${place.name} - —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
          skipped++;
          await new Promise(r => setTimeout(r, 100));
          continue;
        }

        try {
          // –ü–æ–ª—É—á–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑ –í–∏–∫–∏–ø–µ–¥–∏–∏
          let desc = '';
          try {
            const searches = [
              place.name + ' —Å–µ–ª–æ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω',
              place.name + ' –≥–æ—Ä–æ–¥ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω',
              place.name + ' –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω'
            ];

            for (const query of searches) {
              const sr = await fetch(
                `https://ru.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*&srlimit=3`
              );
              const sj = await sr.json();
              const results = sj?.query?.search || [];

              for (const r of results) {
                const snippet = (r.snippet || '').toLowerCase();
                if (snippet.includes('—Ä–æ–¥–∏–ª—Å—è') || snippet.includes('–±–∏–æ–≥—Ä–∞—Ñ–∏—è')) continue;

                const pr = await fetch(
                  `https://ru.wikipedia.org/w/api.php?action=query&prop=extracts&exintro=true&explaintext=true&titles=${encodeURIComponent(r.title)}&format=json&origin=*`
                );
                const pg = Object.values((await pr.json())?.query?.pages || {})[0];
                const text = (pg?.extract || '').trim();

                if (text.length > 80 && (text.toLowerCase().includes('—Å–µ–ª–æ') || text.toLowerCase().includes('–≥–æ—Ä–æ–¥'))) {
                  desc = text.slice(0, 300);
                  break;
                }
              }
              if (desc) break;
            }
          } catch (e) {
            console.log(`‚ö†Ô∏è –í–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è ${place.name}`);
          }

          // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É
          const { error } = await sb.from('markers').insert([{
            lat: place.lat,
            lng: place.lng,
            name: place.name,
            desc: desc || `${place.name} ‚Äî –Ω–∞—Å–µ–ª—ë–Ω–Ω—ã–π –ø—É–Ω–∫—Ç –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ.`
          }]);

          if (error) throw error;

          console.log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: ${place.name}`);
          added++;
          await new Promise(r => setTimeout(r, 500));

        } catch (err) {
          console.error(`‚ùå –û—à–∏–±–∫–∞ ${place.name}:`, err);
        }
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
      await loadPoints();

      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª
      document.getElementById('autoGenModal').style.display = 'none';
      document.getElementById('autoGenProgress').style.display = 'none';
      document.getElementById('autoGenStart').disabled = false;
      document.getElementById('autoGenBar').style.width = '0%';

      alert(`–ì–æ—Ç–æ–≤–æ!\n\n–î–æ–±–∞–≤–ª–µ–Ω–æ: ${added}\n–ü—Ä–æ–ø—É—â–µ–Ω–æ: ${skipped}`);
    };

    // ‚îÄ‚îÄ ONLINE PRESENCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    (function() {
      try {
        const presenceKey = Math.random().toString(36).slice(2);
        const ch = sb.channel('online-presence', { config: { presence: { key: presenceKey } } });
        ch.on('presence', { event: 'sync' }, () => {
          const n = Object.keys(ch.presenceState()).length;
          document.getElementById('onlineCount').textContent = n;
        }).subscribe(async status => {
          if (status === 'SUBSCRIBED') await ch.track({ at: Date.now() });
        });
      } catch(e) {
        document.getElementById('onlineCount').textContent = '‚Äî';
      }
    })();

    // Load points on startup
    loadPoints();
  </script>
</body>
</html>
